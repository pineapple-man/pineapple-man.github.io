<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="pineapple-man"><title>SSH 服务 - pineapple-man</title><meta name="author" content="pineapple-man"><meta name="keywords" content="SSH"><link rel="icon" href="https://pineapple-man.github.io/assets/images/logo.svg"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"pineapple-man","sameAs":["https://github.com/pineapple-man","mailto://mingchaohu720@gmail.com"],"image":"logo.png"},"articleBody":"\n¶简介\nSSH（Secure SHell）协议是应用层基础上的安全网络协议。它是专为远程登录会话和其他网络服务提供安全性的协议，即使登陆过程被中途截获，密码也不会泄露。通过 SSH 协议可有效弥补网络中的漏洞。\n\n¶SSH 原理\n通过分析 SSH 的原理，可以更进一步的了解 SSH 的特点，下面总结出 SSH 协议的原理\n¶SSH 口令登录\nSSH 口令登陆的时空原理图如下：\n\n使用 SSH 进行登陆时，主要分为以下几步：\n\n用户使用ssh user@host命令对远程主机发起登录请求\n远程主机将自己的公钥返回给请求主机\n请求主机使用公钥对用户输入的密码进行加密\n请求主机将加密后的密码发送给远程主机\n远程主机使用私钥对密码进行解密\n最后，远程主机判断解密后的密码是否与用户密码一致，如果一致则同意登陆，否则拒绝登陆\n\n\n¶公钥免密登录\nSSH 的另一个的特点是支持免密登陆，那如何让 SSH 免密登陆，实现自动登陆需求呢？\n\nSSH 公钥免密登陆的时空原理图如下：\n\n上图就是 ssh 免密登陆原理图，从上图可以看出，SSH 免密登陆的前提是使用ssh-keygen -t RSA 生成公私秘钥对，然后通过 ssh-copy-id -i ~/.ssh/id_rsa.pub user@host 命令将公钥分发至远程主机，所有已知的公钥会存于 .ssh/authorized_keys 文件中\n\n接下来的每次免密登陆步骤如下：\n\n用户使用 ssh user@host 命令对远程主机发起登陆；\n远程主机对用户返回一个随机串；\n用户所在主机使用私钥对这个随机串进行加密，并将加密的随机串返回至远程主机；\n远程主机使用登陆客户发送过来的公钥对加密随机串进行解密；\n如果解密成功，就证明用户的登陆信息是正确的，则允许登陆；否则拒绝用户登陆\n\n\n¶中间人攻击\n无论是口令登陆还是免密登陆都存在漏洞风险（中间人攻击），原因是两种方式都存在这样的一个步骤——客户端接受服务器的公钥。SSH 不像 https 协议那样，SSH 协议的公钥是没有证书中心（CA）公证的,这就导致如果有人截获了登陆请求，然后冒充远程主机，将伪造的公钥发给用户，那么用户很难辨别真伪，用户再通过伪造的公钥加密密码，再发送给冒充主机，此时冒充的主机就可以获取用户的登陆密码了，那么 SSH 的安全机制就荡然无存了\n\n既然存在这种问题，SSH 就想了一个办法来绕开这个问题，也就是.sknown_hosts文件的作用\n\nThe authenticity of host ‘xx.xx.xx.xx(xx.xx.xx.xx)’ can’t be established.\nECDSA key fingerprint is --------------------------------------.\nAre you sure you want to continue connecting (yes/no)?\n\n上面这段话的意思是，无法确认xx.xx.xx.xx主机的真实性，只知道它的公钥指纹，问你还想继续连接吗？这样我们就可以看到，SSH 是将这个问题抛给了 SSH 使用者，让 SSH 使用者自己来确定是否相信远程主机。但是这样对于用户来说，就存在一个难题，用户怎么知道远程主机的公钥指纹是多少？此时就需要远程主机必须公开自己的公钥指纹，以便用户自行核对\n在经过用户的风险衡量以后，用户输入 yes 来决定接受这个远程主机的公钥。紧接着，系统会出现以下这样的一句提示，表示远程主机已经得到认可：\n\nWarning: Permanently added ‘xx.xx.xx.xx’ (ECDSA) to the list of known hosts.\n\n当远程主机的公钥被接受以后，它就会被保存在文件~/.ssh/known_hosts 之中。下次再连接这台主机，系统就会认出它的公钥已经保存在本地了，从而跳过警告部分，直接提示输入密码。\n但是由于 known_hosts 这个机制的存在，也会引起一些问题，比如：远程主机的重新装操作系统了，远程主机就会重新生成公钥，如果我们再登陆远程主机时，由于我们本地的 known_hosts 文件中记录了原来的公钥，此时就会提示指纹认证失败的错误，这个时候我们只需要删除本地的 known_hosts 文件即可。\n又比如，我们经常会写一些自动化的脚本，会自动的登陆到远程主机上去，但是这个 known_hosts 机制却必须要我们手动输入 yes 才能完成远程登陆，这样整个自动化登陆就无法完成了，但是我们可以通过修改 /etc/ssh/ssh_config 配置文件，跳过这个 known_hosts 的询问机制，将 # StrictHostKeyChecking ask 修改为 StrictHostKeyChecking no即可\n\n¶ssh 基本用法\nSSH 服务的实现分客户端 openssh-client 和 openssh-server，如果你只是想登陆别的机器的 SSH 只需要安装 openssh-client，如果要使本机开放 SSH 服务就需要安装 openssh-server\n远程管理工具 ssh 具有数据加密传输、网络开销小以及应用平台范围广的特点，是远程管理中最常见的控制工具，是 SSH 协议的一种命令实现\n\n¶ssh 口令登录\n假定你要以用户名 user，登录远程主机 host，只要一条简单命令就可以了\n12345ssh user@host   # 如：ssh root@192.168.0.111ssh host        # 如果本地用户名与远程用户名一致，登录时可以省略用户名。ssh -p 2222 user@host # 使用p参数，可以修改这个端口\n¶ssh 免密登录配置\n使用 ssh 免密登录主要分为如下四步：\n1. 修改 sshd 服务的配置文件，服务端需要支持免密登陆\n12345vim /etc/ssh/sshd_config#---------------------------------将以下几个选项取消注释RSAAuthentication yes     ## RSA认证PubkeyAuthentication yes  ## 公钥认证AuthorizedKeysFile .ssh/authorized_keys  ## 公钥认证文件路径\n由于修改了配置文件所以需要重新启动ssh服务，systemctl restart sshd\n\n2. 客户端生成公钥和私钥\n1234# 进入到当前用户的家目录cd ~/.ssh# 最终会在 ~/.ssh 生成 rsa 公私钥,id_rsa id_rsa.pub 两个文件ssh-keygen -t rsa\n如果当前目录已经存在id_rsa文件，最好生成其他文件的名的公私钥匙\n\n3. 将客户端的公钥上传到服务端\n1ssh-copy-id user@host\n4. 配置本地 config 文件\n1234567## Read more about SSH config files: https://linux.die.net/man/5/ssh_config## 文件在 ~/.ssh/configHost hostname\t\t\t#方便使用者区别机器的名字    HostName hostname\t#目的机器的IP    User root\t\t\t## ssh 登录时的用户名    Port 22\t\t\t\t## ssh 使用的端口，默认是22    IdentityFile\t\t#id_rsa.pub文件对应私钥所在的文件路径\n¶使 ssh 远程连接速度加快\n\n修改 ssh 远程服务配置文件\n\n1234vim /etc/ssh/#------------------GSSAPIAuthentication noUseDNS\tno\n\n修改 hosts 文件\n\n1vim /etc/hosts\t#将连接的主机名加入到当前文件中\n\n重启 ssh 服务\n\n1systemctl restart sshd\n¶SSH 端口转发\n使用 SSH 能够做到端口转发功能，主要分为两种：本地端口转发以及远程端口转发\n¶本地端口转发\n有时需要将指定数据传送到目标主机，从而形成点对点的「端口转发通信」。为了区别后文的「远程端口转发」，把这种情况称为「本地端口转发」（Local forwarding）\n假定 host1 是本地主机，host2 是远程主机。由于种种原因，这两台主机之间无法连通。但是，另外还有一台 host3，可以同时连通前面两台主机。因此，很自然的想法就是，通过 host3，将 host1 连上 host2\n在 host1 执行下面的命令：\nssh -L 2121:host2:21 host3\n命令中的 L 参数一共接受三个值，分别是「本地端口:目标主机:目标主机端口」，它们之间用冒号分隔\n这条命令的意思是：指定 SSH 绑定本地端口 2121，然后指定 host3 将所有的数据，转发到目标主机 host2 的 21 端口（假定 host2 运行 FTP，默认端口为 21）。\n这样一来，只要连接 host1 的 2121 端口，就等于连上了 host2 的 21 端口\nftp localhost:2121\n「本地端口转发」使得 host1 和 host3 之间仿佛形成一个数据传输的秘密隧道，因此又被称为「SSH 隧道」\n\n下面是一个比较有趣的例子。\nssh -L 5900:localhost:5900 host3\n它表示将本机的 5900 端口绑定 host3 的 5900 端口（这里的 localhost 指的是 host3，因为目标主机是相对 host3 而言的）\n另一个例子是通过 host3 的端口转发，ssh 登录 host2。\nssh -L 9001:host2:22 host3\n这时，只要 ssh 登录本机的 9001 端口，就相当于登录 host2\nssh -p 9001 localhost\n\n¶远程端口转发\n本地端口转发是指绑定本地端口的转发，那么「远程端口转发」（remote forwarding）是指绑定远程端口的转发\nhost1 与 host2 之间无法连通，必须借助 host3 转发。但是，特殊情况出现了，host3 是一台内网机器，它可以连接外网的 host1，但是反过来外网的 host1 连不上内网的 host3。此时「本地端口转发」就不能用了，可以使用如下方式解决：由于 host3 可以连 host1，那么就从 host3 上建立与 host1 的 SSH 连接，然后在 host1 上 使用这条连接就可以做到双方进行通信\n我们在 host3 执行下面的命令：\nssh -R 2121:host2:21 host1\nR 参数也是接受三个值，分别是「远程主机端口:目标主机:目标主机端口」\n这条命令的意思，让 host1 监听它自己的 2121 端口，然后将所有数据经由 host3，转发到 host2 的 21 端口。由于对于 host3 来说，host1 是远程主机，所以这种情况就被称为「远程端口绑定」\n绑定之后，我们在 host1 就可以连接 host2 了：\nftp localhost:2121\n\n这里必须指出，「远程端口转发」的前提条件是：host1 和 host3 两台主机都有 sshd 和 ssh 客户端\n¶SCP 常见用法\nscp 是 secure copy 的简写，用于在 Linux 下进行远程拷贝文件的命令，和它类似的命令有 cp，不过 cp 只是在本机进行拷贝不能跨服务器，而且 scp 传输是加密的。可能会稍微影响一下速度。两台主机之间复制文件必须同时有两台主机的复制执行帐号和操作权限\n12345678# 把远程的文件复制到本地scp root@www.test.com:/val/test/test.tar.gz /val/test/test.tar.gz# 把远程的目录复制到本地scp -r root@www.test.com:/val/test/ /val/test/# 把本地的文件复制到远程主机上scp /val/test.tar.gz root@www.test.com:/val/test.tar.gz# 把本地的目录复制到远程主机上scp -r ./ubuntu_env/ root@192.168.0.111:/home/test\n¶附录\nssh 登录原理解析\n什么是 SSH 以及常见的 ssh 功能\nSSH 三步解决免密登录\nMobaXterm 监控服务器的资源(CPU/RAM/Network/disk/…) 使用情况\n","dateCreated":"2022-01-07T15:41:30+00:00","dateModified":"2023-06-07T02:13:34+00:00","datePublished":"2022-01-07T15:41:30+00:00","description":"SSH 是进行 Linux 访问时不可避免的一种操作，平时一直在使用，每次使用就依靠百度，感觉并没有提升，所以搜索相关资料，在本文总结 SSH 相关知识","headline":"SSH 服务","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://pineapple-man.github.io/ssh-%E6%9C%8D%E5%8A%A1/"},"publisher":{"@type":"Organization","name":"pineapple-man","sameAs":["https://github.com/pineapple-man","mailto://mingchaohu720@gmail.com"],"image":"logo.png","logo":{"@type":"ImageObject","url":"logo.png"}},"url":"https://pineapple-man.github.io/ssh-%E6%9C%8D%E5%8A%A1/","keywords":"操作系统"}</script><meta name="description" content="SSH 是进行 Linux 访问时不可避免的一种操作，平时一直在使用，每次使用就依靠百度，感觉并没有提升，所以搜索相关资料，在本文总结 SSH 相关知识"><meta property="og:type" content="blog"><meta property="og:title" content="SSH 服务"><meta property="og:url" content="https://pineapple-man.github.io/ssh-%E6%9C%8D%E5%8A%A1/"><meta property="og:site_name" content="pineapple-man"><meta property="og:description" content="SSH 是进行 Linux 访问时不可避免的一种操作，平时一直在使用，每次使用就依靠百度，感觉并没有提升，所以搜索相关资料，在本文总结 SSH 相关知识"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/ssh%E5%8E%9F%E7%90%86%E6%97%B6%E7%A9%BA%E5%9B%BE.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E9%99%86.png"><meta property="article:published_time" content="2022-01-07T15:41:30.000Z"><meta property="article:modified_time" content="2023-06-07T02:13:34.007Z"><meta property="article:author" content="pineapple-man"><meta property="article:tag" content="操作系统"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/ssh%E5%8E%9F%E7%90%86%E6%97%B6%E7%A9%BA%E5%9B%BE.png"><meta property="og:image" content="https://pineapple-man.github.io/assets/images/logo.png"><link rel="stylesheet" href="/assets/css/style-oth3meuzcjopbgwqbdvoxqknhcm0sy9wkullcc94zhkkop3pmfrpl5t4fzzz.min.css"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-210516333-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-210516333-1")</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"></head><body><div id="blog"><header id="header" data-behavior="5"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/" aria-label="">pineapple-man</a></div><a class="header-right-picture" href="#about" aria-label="打开链接: /#about"><img class="header-picture" src="/assets/images/logo.png" alt="作者的图片"></a></header><nav id="sidebar" data-behavior="5"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about" aria-label="阅读有关作者的更多信息"><img class="sidebar-profile-picture" src="/assets/images/logo.png" alt="作者的图片"></a><h4 class="sidebar-profile-name">pineapple-man</h4><h5 class="sidebar-profile-bio"><p>做一个菠萝：站得笔直，头戴王冠，内心甜美</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/" rel="noopener" title="首页"><i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories" rel="noopener" title="分类"><i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags" rel="noopener" title="标签"><i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives" rel="noopener" title="归档"><i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="#about" rel="noopener" title="关于"><i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i> <span class="sidebar-button-desc">关于</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/pineapple-man" target="_blank" rel="noopener" title="GitHub"><i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto://mingchaohu720@gmail.com" target="_blank" rel="noopener" title="邮箱"><i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul></div></nav><div id="main" data-behavior="5" class="hasCoverMetaIn"><article class="post"><div class="post-header main-content-wrap text-center"><h1 class="post-title">SSH 服务</h1><div class="post-meta"><time datetime="2022-01-07T15:41:30+00:00">1月 07, 2022 </time><span>发布在 </span><a class="category-link" href="/categories/%E9%80%9A%E7%94%A8%E6%8A%80%E8%83%BD/">通用技能</a> <i class="fas fa-book-open"></i> 本文共<span class="post-count"> 2.9k </span>字 <i class="far fa-clock"></i> 阅读预计<span class="post-count"> 28 </span>分钟</div></div><div class="post-content markdown"><div class="main-content-wrap"><h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSH-%E5%8E%9F%E7%90%86"><span class="toc-text">SSH 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SSH-%E5%8F%A3%E4%BB%A4%E7%99%BB%E5%BD%95"><span class="toc-text">SSH 口令登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E9%92%A5%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="toc-text">公钥免密登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB"><span class="toc-text">中间人攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">ssh 基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh-%E5%8F%A3%E4%BB%A4%E7%99%BB%E5%BD%95"><span class="toc-text">ssh 口令登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh-%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E9%85%8D%E7%BD%AE"><span class="toc-text">ssh 免密登录配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF-ssh-%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E9%80%9F%E5%BA%A6%E5%8A%A0%E5%BF%AB"><span class="toc-text">使 ssh 远程连接速度加快</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSH-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-text">SSH 端口转发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-text">本地端口转发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-text">远程端口转发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SCP-%E5%B8%B8%E8%A7%81%E7%94%A8%E6%B3%95"><span class="toc-text">SCP 常见用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-text">附录</span></a></li></ol><h2 id="简介"><a class="header-anchor" href="#简介">¶</a>简介</h2><div class="alert success no-icon"><p>SSH（Secure SHell）协议是<strong>应用层基础上的安全网络协议</strong>。它是<strong>专为远程登录会话和其他网络服务提供安全性的协议</strong>，即使登陆过程被中途截获，密码也不会泄露。通过 SSH 协议可有效弥补网络中的漏洞。</p></div><h2 id="SSH-原理"><a class="header-anchor" href="#SSH-原理">¶</a>SSH 原理</h2><p>通过分析 SSH 的原理，可以更进一步的了解 SSH 的特点，下面总结出 SSH 协议的原理</p><h3 id="SSH-口令登录"><a class="header-anchor" href="#SSH-口令登录">¶</a>SSH 口令登录</h3><p>SSH 口令登陆的时空原理图如下：</p><div class="figure fig-100 center"><a class="fancybox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/ssh原理时空图.png" data-caption="" data-fancybox="default"><img class="fig-img" src="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/ssh原理时空图.png" alt=""></a></div><p>使用 SSH 进行登陆时，主要分为以下几步：</p><div class="alert success no-icon"><ol><li>用户使用<code>ssh user@host</code>命令对远程主机发起登录请求</li><li>远程主机将自己的公钥返回给请求主机</li><li>请求主机使用公钥对用户输入的密码进行加密</li><li>请求主机将加密后的密码发送给远程主机</li><li>远程主机使用私钥对密码进行解密</li><li>最后，远程主机判断解密后的密码是否与用户密码一致，如果一致则同意登陆，否则拒绝登陆</li></ol></div><h3 id="公钥免密登录"><a class="header-anchor" href="#公钥免密登录">¶</a>公钥免密登录</h3><div class="alert success no-icon"><p>SSH 的另一个的特点是支持免密登陆，那如何让 SSH 免密登陆，实现<strong>自动登陆需求</strong>呢？</p></div><p>SSH 公钥免密登陆的时空原理图如下：</p><div class="figure fig-100 center"><a class="fancybox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/ssh免密登陆.png" data-caption="" data-fancybox="default"><img class="fig-img" src="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/ssh免密登陆.png" alt=""></a></div><div class="alert info no-icon"><p>上图就是 ssh 免密登陆原理图，从上图可以看出，SSH 免密登陆的前提是使用<code>ssh-keygen -t RSA</code> 生成公私秘钥对，然后通过 <code>ssh-copy-id -i ~/.ssh/id_rsa.pub user@host</code> 命令将公钥分发至远程主机，所有已知的公钥会存于 <code>.ssh/authorized_keys</code> 文件中</p></div><p>接下来的每次免密登陆步骤如下：</p><div class="alert success no-icon"><ol><li>用户使用 ssh user@host 命令对远程主机发起登陆；</li><li>远程主机对用户返回一个随机串；</li><li>用户所在主机使用私钥对这个随机串进行加密，并将加密的随机串返回至远程主机；</li><li>远程主机使用登陆客户发送过来的公钥对加密随机串进行解密；</li><li>如果解密成功，就证明用户的登陆信息是正确的，则允许登陆；否则拒绝用户登陆</li></ol></div><h3 id="中间人攻击"><a class="header-anchor" href="#中间人攻击">¶</a>中间人攻击</h3><div class="alert info no-icon"><p>无论是口令登陆还是免密登陆都存在漏洞风险（<strong>中间人攻击</strong>），原因是两种方式都存在这样的一个步骤——<strong>客户端接受服务器的公钥</strong>。SSH 不像 https 协议那样，SSH 协议的公钥是没有证书中心（CA）公证的,这就导致如果有人截获了登陆请求，然后冒充远程主机，将伪造的公钥发给用户，那么用户很难辨别真伪，用户再通过伪造的公钥加密密码，再发送给冒充主机，此时冒充的主机就可以获取用户的登陆密码了，那么 SSH 的安全机制就荡然无存了</p></div><p>既然存在这种问题，SSH 就想了一个办法来绕开这个问题，也就是<code>.sknown_hosts</code>文件的作用</p><blockquote><p>The authenticity of host ‘xx.xx.xx.xx(xx.xx.xx.xx)’ can’t be established.<br>ECDSA key fingerprint is --------------------------------------.<br>Are you sure you want to continue connecting (yes/no)?</p></blockquote><p>上面这段话的意思是，无法确认<code>xx.xx.xx.xx</code>主机的真实性，只知道它的公钥指纹，问你还想继续连接吗？这样我们就可以看到，SSH 是将这个问题抛给了 SSH 使用者，让 SSH 使用者自己来确定是否相信远程主机。但是这样对于用户来说，就存在一个难题，用户怎么知道远程主机的公钥指纹是多少？<strong>此时就需要远程主机必须公开自己的公钥指纹，以便用户自行核对</strong></p><p>在经过用户的风险衡量以后，用户输入 <code>yes</code> 来决定接受这个远程主机的公钥。紧接着，系统会出现以下这样的一句提示，表示远程主机已经得到认可：</p><blockquote><p>Warning: Permanently added ‘xx.xx.xx.xx’ (ECDSA) to the list of known hosts.</p></blockquote><p>当远程主机的公钥被接受以后，它就会被保存在文件~/.ssh/known_hosts 之中。下次再连接这台主机，系统就会认出它的公钥已经保存在本地了，从而跳过警告部分，直接提示输入密码。</p><div class="alert warning no-icon"><p>但是由于 known_hosts 这个机制的存在，也会引起一些问题，比如：远程主机的重新装操作系统了，远程主机就会重新生成公钥，如果我们再登陆远程主机时，由于我们本地的 known_hosts 文件中记录了原来的公钥，此时就会提示指纹认证失败的错误，这个时候我们只需要删除本地的 known_hosts 文件即可。</p><p>又比如，我们经常会写一些自动化的脚本，会自动的登陆到远程主机上去，但是这个 known_hosts 机制却必须要我们手动输入 yes 才能完成远程登陆，这样整个自动化登陆就无法完成了，但是我们可以通过修改 <code>/etc/ssh/ssh_config</code> 配置文件，跳过这个 known_hosts 的询问机制，将 <code># StrictHostKeyChecking ask</code> 修改为 <code>StrictHostKeyChecking no</code>即可</p></div><h2 id="ssh-基本用法"><a class="header-anchor" href="#ssh-基本用法">¶</a>ssh 基本用法</h2><p>SSH 服务的实现分客户端 <code>openssh-client</code> 和 <code>openssh-server</code>，如果你只是想登陆别的机器的 SSH 只需要安装 openssh-client，如果要使本机开放 SSH 服务就需要安装 openssh-server</p><div class="alert success no-icon"><p>远程管理工具 ssh 具有数据加密传输、网络开销小以及应用平台范围广的特点，是远程管理中最常见的控制工具，是 SSH 协议的一种命令实现</p></div><h3 id="ssh-口令登录"><a class="header-anchor" href="#ssh-口令登录">¶</a>ssh 口令登录</h3><p>假定你要以用户名 user，登录远程主机 host，只要一条简单命令就可以了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host   <span class="comment"># 如：ssh root@192.168.0.111</span></span><br><span class="line"></span><br><span class="line">ssh host        <span class="comment"># 如果本地用户名与远程用户名一致，登录时可以省略用户名。</span></span><br><span class="line"></span><br><span class="line">ssh -p 2222 user@host <span class="comment"># 使用p参数，可以修改这个端口</span></span><br></pre></td></tr></table></figure><h3 id="ssh-免密登录配置"><a class="header-anchor" href="#ssh-免密登录配置">¶</a>ssh 免密登录配置</h3><p>使用 ssh <strong>免密登录</strong>主要分为<font style="color:red;font-weight:700">如下四步</font>：</p><p><font style="color:red;font-weight:700">1. 修改 sshd 服务的配置文件，服务端需要支持免密登陆</font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line"><span class="comment">#---------------------------------将以下几个选项取消注释</span></span><br><span class="line">RSAAuthentication <span class="built_in">yes</span>     <span class="comment">## RSA认证</span></span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span>  <span class="comment">## 公钥认证</span></span><br><span class="line">AuthorizedKeysFile .ssh/authorized_keys  <span class="comment">## 公钥认证文件路径</span></span><br></pre></td></tr></table></figure><div class="alert info no-icon"><p>由于修改了配置文件所以需要重新启动<code>ssh</code>服务，<code>systemctl restart sshd</code></p></div><p><font style="color:red;font-weight:700">2. 客户端生成公钥和私钥</font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到当前用户的家目录</span></span><br><span class="line"><span class="built_in">cd</span> ~/.ssh</span><br><span class="line"><span class="comment"># 最终会在 ~/.ssh 生成 rsa 公私钥,id_rsa id_rsa.pub 两个文件</span></span><br><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure><div class="alert info no-icon"><p>如果当前目录已经存在<code>id_rsa</code>文件，最好生成其他文件的名的公私钥匙</p></div><p><font style="color:red;font-weight:700">3. 将客户端的公钥上传到服务端</font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id user@host</span><br></pre></td></tr></table></figure><p><font style="color:red;font-weight:700">4. 配置本地 config 文件</font></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## Read more about SSH config files: https://linux.die.net/man/5/ssh_config</span><br><span class="line">## 文件在 ~/.ssh/config</span><br><span class="line">Host hostname			#方便使用者区别机器的名字</span><br><span class="line">    HostName hostname	#目的机器的IP</span><br><span class="line">    User root			## ssh 登录时的用户名</span><br><span class="line">    Port 22				## ssh 使用的端口，默认是22</span><br><span class="line">    IdentityFile		#id_rsa.pub文件对应私钥所在的文件路径</span><br></pre></td></tr></table></figure><h3 id="使-ssh-远程连接速度加快"><a class="header-anchor" href="#使-ssh-远程连接速度加快">¶</a>使 ssh 远程连接速度加快</h3><ol><li>修改 ssh 远程服务配置文件</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">------------------</span></span><br><span class="line">GSSAPIAuthentication no</span><br><span class="line">UseDNS	no</span><br></pre></td></tr></table></figure><ol start="2"><li>修改 hosts 文件</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts	#将连接的主机名加入到当前文件中</span><br></pre></td></tr></table></figure><ol start="3"><li>重启 ssh 服务</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><h2 id="SSH-端口转发"><a class="header-anchor" href="#SSH-端口转发">¶</a>SSH 端口转发</h2><p>使用 SSH 能够做到端口转发功能，主要分为两种：本地端口转发以及远程端口转发</p><h3 id="本地端口转发"><a class="header-anchor" href="#本地端口转发">¶</a>本地端口转发</h3><p>有时需要将指定数据传送到目标主机，从而形成点对点的「端口转发通信」。为了区别后文的「远程端口转发」，把这种情况称为「本地端口转发」（Local forwarding）</p><div class="alert info no-icon"><p>假定 host1 是本地主机，host2 是远程主机。由于种种原因，这两台主机之间无法连通。但是，另外还有一台 host3，可以同时连通前面两台主机。因此，很自然的想法就是，通过 host3，将 host1 连上 host2</p><p>在 host1 执行下面的命令：<br><code>ssh -L 2121:host2:21 host3</code><br>命令中的 L 参数一共接受三个值，分别是「<strong>本地端口:目标主机:目标主机端口</strong>」，它们之间用冒号分隔<br>这条命令的意思是：指定 SSH 绑定本地端口 2121，然后指定 host3 将所有的数据，转发到目标主机 host2 的 21 端口（假定 host2 运行 FTP，默认端口为 21）。<br>这样一来，只要连接 host1 的 2121 端口，就等于连上了 host2 的 21 端口<br><code>ftp localhost:2121</code><br>「本地端口转发」使得 host1 和 host3 之间仿佛形成一个数据传输的秘密隧道，因此又被称为「<strong>SSH 隧道</strong>」</p></div><div class="alert warning no-icon"><p>下面是一个比较有趣的例子。<br><code>ssh -L 5900:localhost:5900 host3</code><br>它表示将本机的 5900 端口绑定 host3 的 5900 端口（这里的 localhost 指的是 host3，因为目标主机是相对 host3 而言的）<br>另一个例子是通过 host3 的端口转发，ssh 登录 host2。<br><code>ssh -L 9001:host2:22 host3</code><br>这时，只要 ssh 登录本机的 9001 端口，就相当于登录 host2<br><code>ssh -p 9001 localhost</code></p></div><h3 id="远程端口转发"><a class="header-anchor" href="#远程端口转发">¶</a>远程端口转发</h3><p>本地端口转发是指绑定本地端口的转发，那么「远程端口转发」（remote forwarding）是指<strong>绑定远程端口的转发</strong></p><div class="alert warning no-icon"><p>host1 与 host2 之间无法连通，必须借助 host3 转发。但是，特殊情况出现了，host3 是一台<strong>内网机器</strong>，它可以连接<strong>外网</strong>的 host1，但是反过来外网的 host1 连不上内网的 host3。此时「本地端口转发」就不能用了，可以使用如下方式解决：由于 host3 可以连 host1，那么就从 host3 上建立与 host1 的 SSH 连接，然后在 host1 上 使用这条连接就可以做到双方进行通信<br>我们在 host3 执行下面的命令：<br><code>ssh -R 2121:host2:21 host1</code><br>R 参数也是接受三个值，分别是「<strong>远程主机端口:目标主机:目标主机端口</strong>」<br>这条命令的意思，让 host1 监听它自己的 2121 端口，然后将所有数据经由 host3，转发到 host2 的 21 端口。由于对于 host3 来说，host1 是远程主机，所以这种情况就被称为「远程端口绑定」<br>绑定之后，我们在 host1 就可以连接 host2 了：<br><code>ftp localhost:2121</code></p></div><p>这里必须指出，「远程端口转发」的前提条件是：host1 和 host3 两台主机都有 sshd 和 ssh 客户端</p><h2 id="SCP-常见用法"><a class="header-anchor" href="#SCP-常见用法">¶</a>SCP 常见用法</h2><p>scp 是 secure copy 的简写，用于在 Linux 下进行远程拷贝文件的命令，和它类似的命令有 cp，不过 cp 只是在本机进行拷贝不能跨服务器，而且 scp 传输是<strong>加密的</strong>。可能会稍微影响一下速度。两台主机之间复制文件必须同时有两台主机的复制执行帐号和操作权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把远程的文件复制到本地</span></span><br><span class="line">scp root@www.test.com:/val/test/test.tar.gz /val/test/test.tar.gz</span><br><span class="line"><span class="comment"># 把远程的目录复制到本地</span></span><br><span class="line">scp -r root@www.test.com:/val/test/ /val/test/</span><br><span class="line"><span class="comment"># 把本地的文件复制到远程主机上</span></span><br><span class="line">scp /val/test.tar.gz root@www.test.com:/val/test.tar.gz</span><br><span class="line"><span class="comment"># 把本地的目录复制到远程主机上</span></span><br><span class="line">scp -r ./ubuntu_env/ root@192.168.0.111:/home/test</span><br></pre></td></tr></table></figure><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42616506/article/details/97262632">ssh 登录原理解析</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013452337/article/details/80847113">什么是 SSH 以及常见的 ssh 功能</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/jeikerxiao/article/details/84105529">SSH 三步解决免密登录</a><br><a target="_blank" rel="noopener" href="https://www.shuzhiduo.com/A/MyJxpmqeJn/">MobaXterm 监控服务器的资源(CPU/RAM/Network/disk/…) 使用情况</a></p></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-none-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" data-tooltip="基础环境配置" aria-label="上一篇: 基础环境配置"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/redis-%E8%B8%A9%E5%9D%91%E6%8C%87%E5%8C%97/" data-tooltip="Redis 踩坑指北" aria-label="下一篇: Redis 踩坑指北"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div></article><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });</script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2023 pineapple-man. All Rights Reserved.</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><br>Total <span id="busuanzi_value_site_pv"></span> views. 您是pineapple-man的第<span id="busuanzi_value_site_uv"></span>个小伙伴<br><i class="fas fa-book-open"></i> <span class="post-count">博客字数统计：370.7k</span><script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script></footer></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="5"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" data-tooltip="基础环境配置" aria-label="上一篇: 基础环境配置"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/redis-%E8%B8%A9%E5%9D%91%E6%8C%87%E5%8C%97/" data-tooltip="Redis 踩坑指北" aria-label="下一篇: Redis 踩坑指北"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-times"></i></div><img id="about-card-picture" src="/assets/images/logo.png" alt="作者的图片"><h4 id="about-card-name">pineapple-man</h4><div id="about-card-bio"><p>做一个菠萝：站得笔直，头戴王冠，内心甜美</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>刚毕业就失业</p></div><div id="about-card-location"><i class="fa fa-map-marker-alt"></i><br>西安</div></div></div><div id="cover" style="background-image:url(/assets/images/cover-v1.2.0.jpg)"></div><script src="/assets/js/script-kcoiyt1nxfue7qgcpkrcixymglcc3cuxeg98fy01hqww4nblnhd2ees6j6yc.min.js"></script></body></html>