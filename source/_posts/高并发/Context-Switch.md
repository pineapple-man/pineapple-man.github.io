---
title: Context_Switch
toc: true
clearReading: true
metaAlignment: center
date: 2021-10-23 20:53:00
categories: 高并发
tags: 
    - 高并发
keywords: 上下文切换
excerpt: 本文主要说明操作系统中存在的上下文切换
---
<!-- toc -->

> 本文翻译自[Context Switch Definition](http://www.linfo.org/context_switch.html)，同时加入了部分我个人的理解，如果想要学习更加原始的知识请访问原网址进行学习:smiley:

## 概述

上下文切换（有时也称为进程切换或任务切换）主要是将**CPU的使用权**从一个进程/线程切换到另一个进程/线程

![Context Switch](https://gitee.com/mingchaohu/blog-image/raw/master/image/context-switch.png)

进程（有时也被称为**任务**）是正在执行的程序的一种抽象，在Linux系统中，线程是轻量级进程，它们可以相互之间并行运行，并且相互之间共享相同的地址空间以及共享它们父进程的一切资源（是由父进程创建的子线程）

:question:什么是上下文？

- 上下文就是在任意某一时刻，CPU**寄存器**以及**程序计数器**中保存的值

> :book:寄存器是CPU内部内存非常小但速度非常快（相比于在CPU外部作为主存的RAM而言）的一种设备，寄存器被用来去加速程序的执行速度，存储的通常是程序的中间结果变量
>
> :book:程序计数器是CPU内部一个特殊的寄存器，它指示CPU在其指令序列中的位置，并保存着正在执行的指令的地址或下一条要执行的指令的地址，这取决于具体系统的实现方式

:sparkles:上下文切换可以更详细地描述为内核（即操作系统的和核心）对CPU上的进程（包括线程）执行以下活动：

1. 暂停一个正在某程序的进程，并将该进程的CPU状态（即上下文）存储在内存中的某个地方
2. 从内存中获取下一个进程的上下文，并在CPU的寄存器中恢复它
3. 返回程序计数器指示的位置(即返回进程被中断的代码行)以恢复进程

> :notebook:上下文切换某些时刻也被描述为：内核暂停在某个CPU上运行的进程并恢复先前被暂停的另一个进程

## 上下文切换与模式切换

:notes:上下文切换仅发生在**内核模式**（内核模式是CPU的特权模式，其中只有内核运行，并提供对所有内存位置和所有其他系统资源的访问）,其他的程序，例如应用程序，最初在**用户模式**运行，但是它们可以通过**系统调用**运行**部分内核代码**

> :book:系统调用是在类unix操作系统中，活动进程（即当前在CPU中运行的进程）对内核提供服务的一种请求，例如：**I/O**或**进程创建**

类unix操作系统中存在这两种模式（用户模式、内核模式）意味着：通过系统调用将CPU切换到内核模式时，这种操作虽然简单但却是必须的，这被称为**模式切换**而**不是上下文切换**，因为**这并没有切换当前CPU上运行的进程**

:sparkles:上下文切换与并发的关系

- 上下文切换是多任务操作系统的一大重要特性，在多任务操作系统中，多个进程似乎同时在一个CPU上执行，彼此之间互不干扰
- 这种并发错觉是通过**快速连续发生的上下文切换**（每秒十次或数百次）来实现的

:question:什么原因会导致上下文切换？

- 进程放弃它们在CPU种的执行时间
- 调度器在进程耗尽其**CPU时间片**时进行切换的结果
- 硬件中断同样会导致上下文切换，比如，从硬件设备向内核监听的某个事件发送特定的信号，就会导致上下文切换，典型的例子就是鼠标的移动或键盘的按键

:question:上下文切换是如何实现的？

- Intel 80386或更高的 cpu 保证对上下文切换的硬件支持
- 大多数现代操作系统执行**软件上下文切换**(可以在任何CPU上使用)，而不是**硬件上下文切换**，以获得更好的性能

:vs:软件上下文切换的优缺点

- 软件上下文切换的一个主要优点是：虽然硬件机制保存了几乎所有的CPU状态，但软件可以更具选择性，只保存实际需要保存和重新加载的部分
- 使用软件上下文切换对于提高上下文切换的效率到底有多重要尚且未知

## 上下文切换的花费

:sparkles:上下文切换通常时**计算密集型的**，也就是说：它**需要相当长的处理器时间**，每秒需要做到数百次的上下文切换，额外花费非常多的时间降低了CPU 的利用率

:notes:就CPU时间而言，**上下文切换对系统来说是一个巨大的成本，它可能是操作系统上成本最高的操作**

**上下文切换的成本在消耗CPU时间上一直在下降，但这似乎主要是由于CPU时钟速度的提高**，而不是上下文切换本身效率的提高，与其他操作系统相比，Linux的众多优势之一是**它的上下文切换和模式切换成本极低**

:older_man:设计操作系统设计或高并发场景下，其中的一个主要焦点是：**尽可能地避免不必要的上下文切换**，然而，这在实践中并不容易做到

## 附录

[从Java视角理解系统结构(一)CPU上下文切换](http://ifeve.com/java-context-switch/)

[Context Switch Definition](http://www.linfo.org/context_switch.html)

