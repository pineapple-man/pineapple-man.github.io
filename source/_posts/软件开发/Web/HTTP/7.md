---
date: 2022-01-08 23:30:17
title: HTTP（七）HTTP 连接管理
toc: true
clearReading: true
thumbnailImagePosition: right
metaAlignment: center
categories: Web
tags: HTTP
keywords: HTTP
excerpt: 本文主要讲解 HTTP 协议中的连接管理
thumbnailImage: "https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/http权威指南.jpg"
---
<!-- toc -->

HTTP 规范对 HTTP 报文解释得很清楚，但对 HTTP 连接介绍的并不多，HTTP 连接是 HTTP 报文传输的关键通道

:notebook: 本文主要从以下几个角度介绍 HTTP 连接管理：

- HTTP 是如何使用 TCP 连接的

- TCP 连接的时延、瓶颈以及存在的障碍

- HTTP 的优化，包括并行连接、Keep-Aliva（持久化连接）和管道化连接

- 管理连接时应该做以及不应该做的事情

## TCP 连接

世界上几乎所有的 HTTP 通信都是由 TCP/IP 承载的，TCP/IP 是全球计算机及网络设备都在使用的一种常用的分组交换网络分层协议集。客户端应用程序可以打开一 条 TCP/IP 连接，连接到可能运行在世界任何地方的服务器应用程序。一旦连接建 立起来了，在客户端和服务器的计算机之间交换的报文就永远不会丢失、受损或 失序。

HTTP 连接实际上就是 TCP 连接及其使用规则。TCP 连接是因特网上的可靠连接。 要想正确、快速地发送数据，就需要了解 TCP 的一些基本知识

TCP 为 HTTP 提供了一条可靠的比特传输管道，从 TCP 连接一端填入的字节会从另一端以原有的顺序、正确地传送出来

### TCP 流是分段的、由 IP 分组传送

TCP 的数据是通过名为 IP 分组(或 IP 数据报)的小数据块来发送的。这样的话， 如图 4-3a 所示，HTTP 就是“HTTP over TCP over IP”这个“协议栈”中的最顶层 了。其安全版本 HTTPS 就是在 HTTP 和 TCP 之间插入了一个(称为 TLS 或 SSL 的)密码加密层

HTTP 要传送一条报文时，会以流的形式将报文数据的内容通过一条打开的 TCP 连 接按序传输。TCP 收到数据流之后，会将数据流砍成被称作段的小数据块，并将段 封装在 IP 分组中，通过因特网进行传输。所有这些工作都是由 TCP/ IP 软件来处理的，HTTP 程序员什么都看不到

### 保持 TCP 连接持续不断地运行





## TCP 性能的考虑

:sparkles:本小节列出一些会对 HTTP 应用产生影响的、最常见的因素：

- TCP 连接建立握手
- TCP 慢启动拥塞控制
- 数据聚集的 Nagle 算法
- 用于捎带确认的 TCP 延迟确认算法
- TIME_WAIT 时延和端口耗尽

### TCP连接的握手时延



### 延迟确认

由于确认报文很小，所以 TCP 允许在发往相同方向的输出数据分组中对其进行“捎 带”



## HTTP 连接的处理

之前对 TCP 连接及其性能的含义进行了简要的介绍，本文剩余的部分将解释操作和优化连接的 HTTP 技术

从 HTTP 的 Connection 首部开始介绍，这是 HTTP 连接管理中一个很容易被 误解，但又很重要的部分。然后会介绍一些 HTTP 连接优化技术

### 常被误解的**Connection**首部

HTTP 允许在客户端和最终的源端服务器之间存在一串 HTTP 中间实体(代理、高速缓存等)。可以从客户端开始，逐跳地将 HTTP 报文经过这些中间设备，转发到源端服务器上去(或者进行反向传输)



Connection 首部可以承载 3 种不同类型的标签

- HTTP 首部字段名，列出了只与此连接有关的首部
- 任意标签值，用于描述此连接的非标准选项
- 值 close，说明操作完成之后需关闭这条持久连接

### 串行事务处理时延



## 管道化连接



## 关闭连接



### 任意解除连接



#### Content-Length 及截尾操作



#### 连接关闭容限、重试以及幂等性

即使在非错误情况下，连接也可以在任意时刻关闭。HTTP 应用程序要做好正确处理非预期关闭的准备。

如果一个事务，不管是执行一次还是执行很多次，得到的结果都是相同的，这个事务就是「 幂等的 」。客户端不应该以管道化方式传送非幂等请求，否则，传输连接的过早终止就会在造成一些不确定的后果。要发送一条非幂等请求，就需要等待来自前一条请求的响应状态。

### 正常关闭连接

TCP 连接是双向的。TCP 连接的每一端都有一个输入队列和一个 输出队列，用于数据的读或写。放入一端输出队列中的数据最终会出现在另一端的 输入队列中

#### 完全关闭与半关闭



#### TCP 关闭以及重置错误



#### 正常关闭

