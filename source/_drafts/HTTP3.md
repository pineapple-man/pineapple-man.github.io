---
title: HTTP（三）HTTP 认证
toc: true
clearReading: true
thumbnailImagePosition: right
metaAlignment: center
categories: Web
tags: HTTP
keywords: HTTP
excerpt: 本文主要讲解 HTTP 中认证相关技术
thumbnailImage: "https://gitee.com/mingchaohu/blog-image/raw/master/image/http权威指南.jpg"
---

移动互联网的发展，通过 Web 可以方便地访问许多信息。但仅仅方便用户访问是不够的，还需要做到细粒度的用户认证

{% alert warning no-icon%}
例如：某资源网站中，只有登录的用户才能够下载相关资源，没有登录的用户甚至看不到资源下载地址，这就是一种典型的细粒度用户认证案例。未授权用户无法查看其他用户的个人隐私数据，也不能在未经许可的情况下向 Web 站点发布文档。
{%endalert%}

本章将阐述 HTTP 的认证机制，深入介绍最常见的 HTTP 认证的两种形式：**基本认证**（basic authentication）以及**摘要认证**（digest authentication）

## 概述

:question:什么是认证？
{% alert success no-icon%}

认证是一种验证身份的技术，通过这种技术服务器可以了解用户的身份，一旦服务器知道了用户身份，就可以判定用户可以访问的事务和资源了。通常是通过提供用户名和密码进行认证的。尽管可以在 HTTP 的认证形式和 cookie 基础之上运行自己的认证工具，但在很多情况下，HTTP 的原生认证功能就可以很好地满足要求
{%endalert%}

## HTTP 认证框架

HTTP 提供了一个原生的质询 / 响应（challenge/response）框架，简化了对用户的认证过程

{% image fancybox fig-100  center https://gitee.com/mingchaohu/blog-image/raw/master/image/http质询响应框架.png %}

:sailboat:认证逻辑
{% alert success no-icon%}
- Web 应用程序收到一条 HTTP 请求报文时，服务器没有按照请求执行动作，而是以一个**认证质询**进行响应，要求用户提供一些保密信息来说明他是谁，从而对其进行质询
- 用户再次发起请求时，要附上保密证书（用户名和密码）。如果证书不匹配，服务器 可以再次质询客户端，或产生一条错误信息。如果证书匹配，就可以正常完成请求了。
{%endalert%}

## 认证协议与首部

HTTP 通过一组可定制的控制首部，为不同的认证协议提供了一个可扩展的认证框架，下图列出的首部格式和内容会随认证协议的不同而发生变化。认证协议也是在 HTTP 认证首部中指定的

请求认证的四个步骤

| 步骤 |         首部          |                             描述                             |    方法/状态     |
| :--: | :-------------------: | :----------------------------------------------------------: | :--------------: |
| 请求 |                       |             第一条请求没有认证信息，只是请求资源             |       GET        |
| 质询 |  `WWW-Authenticate`   | 服务器用 401 状态拒绝了请求，说明需要用 户提供用户名和密码。 服务器上可能会分为不同的区域，每个区 域都有自己的密码，所以服务器会在 `WWW-Authenticate`首部对保护区域进行描述。 同样，认证算法也是在 WWW-Authenticate 首部中指定的 | 401 Unauthorized |
| 授权 |    `Authorization`    | 客户端重新发出请求，但这一次会附加一个 Authorization 首部，用来说明认证算法、 用户名和密码 |      `GET`       |
| 成功 | `Authentication-Info` | 如 果 授 权 证 书 是 正 确 的， 服 务 器 就 会 将 文 档 返 回。 有 些 授 权 算 法 会 在 可 选 的 Authentication-Info 首部返回一些与授 权会话相关的附加信息 |     `200 OK`     |

基本认证实例如下：
{% image fancybox fig-100  center  https://gitee.com/mingchaohu/blog-image/raw/master/image/基本认证实例.png %}

服务器对用户进行质询时，会返回一条 401 Unauthorized 响应，并在 WWW-Authenticate 首部说明如何以及在哪里进行认证
当客户端授权服务器继续处理时，会重新发送请求，但会在 Authorization 首部 附上加密的密码和其他一些认证参数
授权请求成功完成时，服务器会返回一个正常的状态码（比如，200 OK）；对高级认证算法来说，可能还会在 Authentication-Info 首部附加一些额外的信息

### 安全域（Realm）

:question:HTTP 是怎样允许服务器为不同的资源使用不同的访问权限的？

上图中，WWW-Authenticate 质询中包含了一个 `realm` 指令。Web 服务器会将受保护的文档组织成一个安全域（`security realm`），每个安全域都可以有不同的授权用户集
{% alert warning no-icon%}

比如，假设 Web 服务器建立了两个安全域：一个用于公司的财务信息，另一个用于个人家庭文档。不同的用户对各个安全域的访问权限是不同的。 公司的 CEO 应该能够访问销售额预测资料，但不应该允许他访问员工和其家人度假的照片！

{%endalert%}

下面是一个假想的基本认证质询，它指定了一个域

```http
HTTP/1.0 401 Unauthorized
WWW-Authenticate: Basic realm="Corporate Financials"
```

域(`realm`)应该有一个描述性的字符名，比如 Corporate Financials（公司财务资料），以帮助用户了解应该使用哪个用户名和密码。在安全域的名称中列出服务器主机名也是很有帮助的——比如，
```http
HTTP/1.0 401 Unauthorized
WWW-Authenticate: Basic realm="executive-committee@bigcompany.com"
```

## 基本认证

基本认证是最流行的 HTTP 认证协议。几乎每个主要的客户端和服务器都实现了基本认证机制。在基本认证中，Web 服务器可以拒绝一个事务，质询客户端，请用户提供有效的用户名和密码。**服务器会返回 401 状态码，而不是 200 状态码来初始化认证质询**，并用 WWW-Authenticate 响应首部指定要访问的安全域。浏览器收到质询时，会打开一个对话框，请求用户输入这个域的用户名和密码。然后将用户名和密码稍加扰码，再用 Authorization 请求首部回送给服务器

### 基本认证实例

下表总结了 HTTP 基本认证的 WWW-Authenticate 和 Authorization 首部

|         质询/响应         |                        首部语法及描述                        |
| :-----------------------: | :----------------------------------------------------------: |
| 质询（服务器发往客户端） | 网站的不同部分可能有不同的密码。域就是一个引用字符串，用来命名所请求的文档集，这样用户就知道该使用哪个密码了`WWW-Authenticate: Basic realm=quoted-realm` |
| 响应（客户端发往服务器） | 用冒号（ `:`）将用户名和密码连接起来，然后转换成 Base-64 编码，这样能尽量避免攻击者通过观察网络流量并只进行一些粗略的检查就获取用户名和密码的情况发生： Authorization: Basic base64-username-and-password |

:notes:基本认证协议并没有使用 `Authentication-Info` 首部

## Base-64 用户名/密码编码

:question:什么是base64编码
{% alert success no-icon%}

简单来说，Base-64 编码是一种编码格式，会将一个 8 位字节序列划分为一些 6 位的块。用每个 6 位的块在一个特殊的由 64 个字符组成的字母表中选择一个字符，这个字母表中包含了大部分字母和数字
{%endalert%}

Base-64 编码可以接受二进制字符串、文本、国际字符表示的数据（在某些系统中会引发一些问题），将其暂时转换成一个易移植的字母表以便传输。然后，在远端就可以解码出原始字符串，而无需担心传输错误了

有些用户名和密码中会包含国际字符或其他在 HTTP 首部中非法的字符（比如引号、 冒号和回车换行符），对这些用户名和密码来说，Base-64 编码是非常有用的。而且，Base-64 编码扰乱了用户名和密码，这样也可以防止管理员在管理服务器和网络时，不小心看到用户名和密码

## 代理认证

中间的代理服务器也可以实现认证功能。有些组织会在用户访问服务器、LAN 或无线网络之前，用代理服务器对其进行认证。可以在代理服务器上对访问策略进行集中 管理，因此，通过代理服务器提供对某组织内部资源的统一访问控制是一种很便捷的方式。这个过程的第一步就是通过代理认证（proxy authentication）来识别身份。

代理认证的步骤与 Web 服务器身份验证的步骤相同。但首部和状态码都有所不同。 下表列出了 Web 服务器和代理在认证中使用的状态码和首部的差异

Web服务器与代理认证

|          Web 服务器           |          代理服务器           |
| :---------------------------: | :---------------------------: |
| Unauthorized status code: 401 | Unauthorized status code: 407 |
|       WWW-Authenticate        |      Proxy-Authenticate       |
|         Authorization         |      Proxy-Authorization      |
|      Authentication-Info      |   Proxy-Authentication-Info   |

## 基本认证的安全缺陷

基本认证简单便捷，但并不安全。只能用它来防止非恶意用户无意间进行的访问， 或将其与 SSL 这样的加密技术配合使用。基本认证存在下列安全缺陷。

基本认证会通过网络发送用户名和密码，这些用户名和密码都是以一种很容易解码的形式表示的。实际上，**密码是以明文形式传输的**，任何人都可以读取并将其捕获。虽然 Base-64 编码通过隐藏用户名和密码，致使友好的用户不太可能在进行网络观测时无意中看到密码，但 Base-64 编码的用户名和密码可以很轻易地通过反向编码过程进行解码。所以经过 Base-64 编码的密码实际上就是**明文**传送的。

如果有动机的第三方用户有可能会去拦截基本认证发送的用户名和密码，就要通过 SSL 加密信道发送所有的 HTTP 事务，或者使用更安全的认证协议，比如摘要认证

即使密码是以更难解码的方式加密的，第三方用户仍然可以捕获被修改过的用户名和密码，并将修改过的用户名和密码一次一次地重放给原始服务器，以获得对服务器的访问权。没有什么措施可用来防止这些**重放攻击**

即使将基本认证用于一些不太重要的应用程序，比如公司内部网络的访问控制或个性化内容的访问，一些不良习惯也会让它变得很危险。很多用户由于受不了大量密码保护的服务，会在这些服务间使用相同的用户名和密码。比如说，某个狡猾的恶徒会从免费的因特网邮件网站捕获明文形式的用户名和密码，然后会发现用同样的用户名和密码还可以访问重要的在线银行网站！

基本认证没有提供任何针对代理和作为中间人的中间节点的防护措施，它们没有修改认证首部，但却修改了报文的其余部分，这样就严重地改变了事务的本质

假冒服务器很容易骗过基本认证。如果在用户实际连接到一台恶意服务器或网关的时候，能够让用户相信他连接的是一个受基本认证保护的合法主机，攻击者就可以请求用户输入密码，将其存储起来以备未来使用，然后捏造一条错误信息传送给用户。

这一切说明，在隐私保护并严格的环境中，可以通过基本认证来提供便捷的文档个性化服务或访问控制保护。通过这种方式，可以用基本认证来防止一些好奇的用户无意中或不小心对文档进行访问

比如，在一个公司内部，产品管理可能要对未来的产品计划进行密码保护，以防止信息的过早发布。对一般用户而言，基本认证就足以让他们感到不便而不会再去访问这些数据了。同样，你可能会用密码来保护那些并非高度机密的，或者没什么信息价值的私人照片或私有站点，这些信息确实和其他人也没什么关系。 将基本认证与加密数据传输（比如 SSL）配合使用，向恶意用户隐藏用户名和密码， 会使基本认证变得更加安全，这是一种常用的技巧

## 摘要认证

基本认证便捷灵活，但极不安全。用户名和密码都是以明文形式传送的，用户名和密码用 Base-64 编码进行了扰码，但很容易被解码。只能防止无意中的查看，没有任何防止恶意用户攻击的手段， 也没有采取任何措施防止对报文的篡改。安全使用基本认证的唯一方式就是将其与 SSL 配合使用

摘要认证与基本认证兼容，但却更为安全，尽管摘要认证还没有得到广泛应用，但对实现安全事务来说，这些概念是非常重要的

摘要认证是另一种 HTTP 认证协议，它试图修复基本认证协议的严重缺陷。具体来 说，摘要认证进行了如下改进

- 永远不会以明文方式在网络上发送密码
- 可以防止恶意用户捕获并重放认证的握手过程
- 可以有选择地防止对报文内容的篡改
- 防范其他几种常见的攻击方式

摘要认证并不是最安全的协议，与基于公有密钥的机制相比，摘要认证所提供的认证机制就不够强。同样，摘要认证除了能保护密码外，并没有提供保护其他内容的方式——请求和应答中的其余部分仍然可能被窃听。

摘要认证并不能满足安全 HTTP 事务的很多需求。 对这些需求来说，使用传输层安全（Transport Layer Security，TLS）和安全 HTTP （Secure HTTP，HTTPS）协议更为合适一些

但摘要认证比它要取代的基本认证强大很多。与很多建议其他因特网服务使用的常 用策略相比，（比如曾建议 LDAP、POP 和 IMAP 使用的 CRAM-MD5），摘要认证 也要强大很多

### 用摘要保护密码

摘要认证遵循的箴言是“绝不通过网络发送密码”。客户端不会发送密码，而是会发 送一个“指纹”或密码的“摘要”，这是密码的不可逆扰码。客户端和服务器都知 道这个密码，因此服务器可以验证所提供的摘要是否与密码相匹配。只拿到摘要的 话，除了将所有的密码都拿来试试之外，没有其他方法可以找出摘要是来自哪个密码的！



在图 13-1a 中，客户端请求了某个受保护文档。

 • 在图 13-1b 中，在客户端能够证明其知道密码从而确认其身份之前，服务器拒绝 提供文档。服务器向客户端发起质询，询问用户名和摘要形式的密码。

 • 在图 13-1c 中，客户端传递了密码的摘要，证明它是知道密码的。服务器知道所 有用户的密码（实际上，服务器只需要知道密码的摘要即可）因此可以将客户提供的摘要与服务器自己计算得到的摘要进行 比较，以验证用户是否知道密码。另一方在不知道密码的情况下，很难伪造出正 确的摘要。

 • 在图 13-1d 中，服务器将客户端提供的摘要与服务器内部计算出的摘要进行对比。 如果匹配，就说明客户端知道密码（或者很幸运地猜中了！）。可以设置摘要函 数，使其产生很多数字，让人不可能幸运地猜中摘要。服务器进行了匹配验证之 后，会将文档提供给客户端——整个过程都没有在网络上发送密码

![](https://gitee.com/mingchaohu/blog-image/raw/master/image/摘要实现隐藏密码的认证.png)

有一些技术，比如词典攻击，会首先尝试一些常见的密码。这些密码分析技术可以极大地简化密码破 译进程

## 单向摘要

摘要是“对信息主体的浓缩”。摘要是一种单向函数，主要用于将无限的输入值转 换为有限的浓缩输出值。常见的摘要函数 MD5，会将任意长度的字节序列转换为 一个 128 位的摘要。

理论上来讲，我们将数量无限的输入值转换成了数量有限的输出值，所以两个不同的输入值就可能映 射为同一个摘要。这种情况被称为冲突（collision）。实际上，由于可用输出值的数量足够大，所以在 现实生活中，出现冲突的可能是微乎其微的，对我们要实现的密码匹配来说并不重要

MD5 表示“报文摘要的第五版”，是摘要算法系列中的一种。安全散列算法（Secure Hash Algorithm， SHA）是另一种常见的摘要函数

对这些摘要来说，最重要的是如果不知道密码的话，要想正确地猜出发送给服务器 的摘要将是非常困难的。同样，如果有摘要，想要判断出它是由无数输入值中的哪 一个产生的，也是非常困难的

MD5 输出的 128 位的摘要通常会被写成 32 个十六进制的字符，每个字符表示 4 位。不论输入长度为多少，最终的输出长度是固定的

### 用随机数防止重放攻击

使用单向摘要就无需以明文形式发送密码了。可以只发送密码的摘要，而且可以确 信，没有哪个恶意用户能轻易地从摘要中解码出原始密码

但是，仅仅隐藏密码并不能避免危险，因为即便不知道密码，别有用心的人也可以 截获摘要，并一遍遍地重放给服务器。摘要和密码一样好用

为防止此类重放攻击的发生，服务器可以向客户端发送一个称为随机数（nonce）的特殊令牌，这个数会经常发生变化（可能是每毫秒，或者是每次认证都变化）。客 户端在计算摘要之前要先将这个随机数令牌附加到密码上去

在密码中加入随机数就会使摘要随着随机数的每一次变化而变化。记录下的密码摘 要只对特定的随机值有效，而没有密码的话，攻击者就无法计算出正确的摘要，这 样就可以防止重放攻击的发生

摘要认证要求使用随机数，因为这个小小的重放弱点会使未随机化的摘要认证变得 和基本认证一样脆弱。随机数是在 WWW-Authenticate 质询中从服务器传送给客户 端的

：随机数这个词表示“本次”或“临时的”。在计算机安全的概念中，随机数捕获了一个特定的时间点， 将其加入到安全计算之中

### 摘要认证的握手机制

