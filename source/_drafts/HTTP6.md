---
title: "HTTP（六）安全的 HTTP"
toc: true
clearReading: true
thumbnailImagePosition: right
metaAlignment: center
categories: Web
tags: HTTP
keywords: HTTP
excerpt: 本文主要讲解 HTTP 中的安全问题
thumbnailImage: "https://gitee.com/mingchaohu/blog-image/raw/master/image/http权威指南.jpg"
---
本文主要介绍一种更复杂、更安全的技术，通过数字密码保护 HTTP 事务免受窃听和篡改的侵害

:question:为什么需要安全的 HTTP ？

{% alert success no-icon%}
人们会用 Web 事务来处理一些很重要的事情。如果没有强有力的安全保证，人们就无法安心地进行网络购物或使用银行业务。如果无法严格限制访问权限，公司就不能将重要的文档放在 Web 服务器上。Web 需要一种安全的 HTTP 形式
{%endalert%}

## 保护 HTTP 的安全
前面的章节讨论了一些提供认证（基本认证和摘要认证）和报文完整性检查的轻量级方法，对很多网络事务来说，这些方法都是很好用的，但对大规模的购物、银行事务，或者对访问机密数据来说，并不足够强大。这些更为重要的事务需要将 HTTP 和数字加密技术结合起来使用，才能确保安全

HTTP 的安全版本要高效、可移植且易于管理，不但能够适应不断变化的情况而且还应 该能满足社会和政府的各项要求。我们需要一种能够提供下列功能的 HTTP 安全技术

• 服务器认证（客户端知道它们是在与真正的而不是伪造的服务器通话）。

 • 客户端认证（服务器知道它们是在与真正的而不是伪造的客户端通话）。

 • 完整性（客户端和服务器的数据不会被修改）。

 • 加密（客户端和服务器的对话是私密的，无需担心被窃听）。

 • 效率（一个运行的足够快的算法，以便低端的客户端和服务器使用）。

 • 普适性（基本上所有的客户端和服务器都支持这些协议）。

 • 管理的可扩展性（在任何地方的任何人都可以立即进行安全通信）。

 • 适应性（能够支持当前最知名的安全方法）。 • 在社会上的可行性（满足社会的政治文化需要）

### HTTPS

HTTPS 是最流行的 HTTP 安全形式。它是由网景公司首创的，所有主要的浏览器和 服务器都支持此协议

HTTPS 方案的 URL 以 `https://`，而不是 `http://` 开头，据此就可以分辨某个 Web 页面 是通过 HTTPS 而不是 HTTP 访问的

使用 HTTPS 时，所有的 HTTP 请求和响应数据在发送到网络之前，都要进行加密。 HTTPS 在 HTTP 下面提供了一个传输级的密码安全层—可以使用 SSL，也可以使用其后继者——传输层安全（Transport Layer Security，TLS）。由于 SSL 和 TLS 非常类似，所以我们不太严格地用术语 SSL 来表示 SSL 和 TLS

![](https://gitee.com/mingchaohu/blog-image/raw/master/image/http协议栈位置.jpg)

大部分困难的编码及解码工作都是在 SSL 库中完成的，所以 Web 客户端和服务器 在使用安全 HTTP 时无需过多地修改其协议处理逻辑。在大多数情况下，只需要用SSL 的输入 / 输出调用取代 TCP 的调用，再增加其他几个调用来配置和管理安全信 息就行了

![](https://gitee.com/mingchaohu/blog-image/raw/master/image/Http与Https.png)
HTTPS 是最常见的 HTTP 安全版本。它得到了很广泛的应用，所有主要的商业浏览器和服务器上都提供 HTTPS。HTTPS 将 HTTP 协议与一组强大的对称、非对称和基于证书的加密技术结合在一起，使得 HTTPS 不仅很安全，而且很灵活，很容易在处于无序状态的、分散的全球互联网上进行管理。

HTTPS 加速了因特网应用程序的成长，已经成为基于 Web 的电子商务快速成长的主要推动力。在广域网中对分布式 Web 应用程序的安全管理方面，HTTPS 也是非常重要的。

HTTPS 就是在安全的传输层上发送的 HTTP。HTTPS 没有将未加密的 HTTP 报文发送给 TCP，并通过世界范围内的因特网进行传输它在将HTTP 报文发送给 TCP 之前，先将其发送给了一个安全层，对其进行加密

现在，HTTP 安全层是通过 SSL 及其现代替代协议 TLS 来实现的。我们遵循常见的用法，用术语 SSL 来表示 SSL 或者 TLS

## HTTPS 方案

现在，安全 HTTP 是可选的。因此，对 Web 服务器发起请求时，我们需要有一种方 式来告知 Web 服务器去执行 HTTP 的安全协议版本。这是在 URL 的方案中实现的。

通常情况下，非安全 HTTP 的 URL 方案前缀为 http，在安全 HTTPS 协议中，URL 的方案前缀为 https

请求一个客户端（比如 Web 浏览器）对某 Web 资源执行某事务时，它会去检查 URL 的方案

如果 URL 的方案为 http，客户端就会打开一条到服务器端口 80（默认情况下） 的连接，并向其发送老的 HTTP 命令

如果 URL 的方案为 https，客户端就会打开一条到服务器端口 443（默认情况下） 的连接，然后与服务器“握手”，以二进制格式与服务器交换一些 SSL 安全参数， 附上加密的 HTTP 命令

SSL 是个二进制协议，与 HTTP 完全不同，其流量是承载在另一个端口上的（SSL 通常是由端口 443 承载的）。如果 SSL 和 HTTP 流量都从端口 80 到达，大部分 Web 服务器会将二进制 SSL 流量理解为错误的 HTTP 并关闭连接。将安全服务进一步整 合到 HTTP 层中去就无需使用多个目的端口了，在实际中这样不会引发严重的问题

SSL 是如何与安全服务器建立连接的

### 建立安全传输

在未加密 HTTP 中，客户端会打开一条到 Web 服务器端口 80 的 TCP 连接，发送一 条请求报文，接收一条响应报文，关闭连接。

由于 SSL 安全层的存在，HTTPS 中这个过程会略微复杂一些。在 HTTPS 中，客户 端首先打开一条到 Web 服务器端口 443（安全 HTTP 的默认端口）的连接。一旦建 立了 TCP 连接，客户端和服务器就会初始化 SSL 层，对加密参数进行沟通，并交 换密钥。握手完成之后，SSL 初始化就完成了，客户端就可以将请求报文发送给安 全层了。在将这些报文发送给 TCP 之前，要先对其进行加密。

### SSL 握手

在发送已加密的 HTTP 报文之前，客户端和服务器要进行一次 SSL 握手，在这个握 手过程中，它们要完成以下工作：

- 交换协议版本号； 

- 选择一个两端都了解的密码；
- 对两端的身份进行认证；
- 生成临时的会话密钥，以便加密信道

在通过网络传输任何已加密的 HTTP 数据之前，SSL 已经发送了一组握手数据来建 立通信连接了

这是 SSL 握手的简化版本。根据 SSL 的使用方式，握手过程可能会复杂一些，但总 的思想就是这样

### 服务器证书

SSL 支持双向认证，将服务器证书承载回客户端，再将客户端的证书回送给服务器。 而现在，浏览时并不经常使用客户端证书。大部分用户甚至都没有自己的客户端证 书。

服务器可以要求使用客户端证书，但实际中很少出现这种情况

另一方面，安全 HTTPS 事务总是要求使用服务器证书的。在一个 Web 服务器上执行 安全事务，比如提交信用卡信息时，你总是希望是在与你所认为的那个组织对话。由 知名权威机构签发的服务器证书可以帮助你在发送信用卡或私人信息之前评估你对服 务器的信任度。

服务器证书是一个显示了组织的名称、地址、服务器 DNS 域名以及其他信息的 X.509 v3 派生证书

你和你所用的客户端软件可以检查证书，以确 保所有的信息都是可信的

### 站点证书的有效性



### 虚拟主机与证书



### OpenSSL

SSL 是个复杂的二进制协议。除非你是密码专家，否则就不应该直接发送原始的 SSL 流量。幸运的是，借助一些商业或开源的库，编写 SSL 客户端和服务器并不十 分困难



OpenSSL 是 SSL 和 TLS 最常见的开源实现。OpenSSL 项目由一些志愿者合作开发， 目标是开发一个强壮的、具有完备功能的商业级工具集，以实现 SSL 和 TLS 协议以 及一个全功能的通用加密库。

只要建立起了 SSL 信道，并且客户端对站点的证书没有异议，就可以通过安全信 道来发送其 HTTP 请求了。

## 通过代理以隧道形式传输安全流量

客户端通常会用 Web 代理服务器代表它们来访问 Web 服务器。如，很多公司都会在公司网络和公共因特网的安全边界上放置一个代理。代理是防火墙路由器唯一允许进行 HTTP 流量交换的设备，它可能会进行 病毒检测或其他的内容控制工作。

但只要客户端开始用服务器的公开密钥对发往服务器的数据进行加密，代理就再也 不能读取 HTTP 首部了！代理不能读取 HTTP 首部，就无法知道应该将请求转向何 处了

为了使 HTTPS 与代理配合工作，要进行几处修改以告知代理连接到何处。一种常 用的技术就是 HTTPS SSL 隧道协议。使用 HTTPS 隧道协议，客户端首先要告知代 理，它想要连接的安全主机和端口。这是在开始加密之前，以明文形式告知的，所 以代理可以理解这条信息。

HTTP 通过新的名为 CONNECT 的扩展方法来发送明文形式的端点信息。CONNECT 方 法会告诉代理，打开一条到所期望主机和端口号的连接。这项工作完成之后，直接 在客户端和服务器之间以隧道形式传输数据。CONNECT 方法就是一条单行的文本命 令，它提供了由冒号分隔的安全原始服务器的主机名和端口号。host:port 后面跟 着一个空格和 HTTP 版本字符串，再后面是 CRLF。接下来是零个或多个 HTTP 请 求首部行，后面跟着一个空行。空行之后，如果建立连接的握手过程成功完成，就 可以开始传输 SSL 数据了。下面是一个例子： CONNECT home.netscape.com:443 HTTP/1.0 User-agent: Mozilla/1.1N

在请求中的空行之后，客户端会等待来自代理的响应。代理会对请求进行评估，确 保它是有效的，而且用户有权请求这样一条连接。如果一切正常，代理会建立一条

到目标服务器的连接。如果成功，就向客户端发送一条 200 Connection Established 响应。 HTTP/1.0 200 Connection established Proxy-agent: Netscape-Proxy/1.1

