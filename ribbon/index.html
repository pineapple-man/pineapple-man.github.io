<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="pineapple-man"><title>ribbon - pineapple-man</title><meta name="author" content="pineapple-man"><meta name="keywords" content="ribbon"><link rel="icon" href="https://pineapple-man.github.io/assets/images/logo.svg"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"pineapple-man","sameAs":["https://github.com/pineapple-man","mailto://mingchaohu720@gmail.com"],"image":"logo.png"},"articleBody":"\nÂ¶æ¦‚è¿°\nSpring Cloud Ribbon æ˜¯åŸºäº Netflix Ribbon å®ç°çš„ä¸€å¥—å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å·¥å…·ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æä¾›å®¢æˆ·ç«¯çš„è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•å’ŒæœåŠ¡è°ƒç”¨ã€‚Ribbon å®¢æˆ·ç«¯ç»„ä»¶æä¾›ä¸€ç³»åˆ—å®Œå–„çš„é…ç½®é¡¹å¦‚è¿æ¥è¶…æ—¶ï¼Œé‡è¯•ç­‰ã€‚ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­åˆ—å‡º Load Balancer(ç®€ç§° LB) åé¢æ‰€æœ‰çš„æœºå™¨ï¼ŒRibbon ä¼šè‡ªåŠ¨çš„å¸®åŠ©ä½ åŸºäºæŸç§è§„åˆ™(å¦‚ç®€å•è½®è¯¢ï¼Œéšæœºè¿æ¥ç­‰ï¼‰å»è¿æ¥è¿™äº›æœºå™¨ã€‚æˆ‘ä»¬å¾ˆå®¹æ˜“ä½¿ç”¨ Ribbon å®ç°è‡ªå®šä¹‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•\nğŸ““ Ribbon ç›®å‰ä¹Ÿè¿›å…¥ç»´æŠ¤æ¨¡å¼ã€‚Ribbon æœªæ¥å¯èƒ½è¢« Spring Cloud LoadBalacer æ›¿ä»£\n\nâ“ä»€ä¹ˆæ˜¯ Load Banlance(è´Ÿè½½å‡è¡¡)?\nç®€å•çš„è¯´å°±æ˜¯å°†ç”¨æˆ·çš„è¯·æ±‚å¹³æ‘Šçš„åˆ†é…åˆ°å¤šä¸ªæœåŠ¡ä¸Šï¼Œä»è€Œè¾¾åˆ°ç³»ç»Ÿçš„ HA (é«˜å¯ç”¨)ï¼Œå¸¸è§çš„è´Ÿè½½å‡è¡¡æœ‰è½¯ä»¶ Nginxï¼ŒLVSï¼Œç¡¬ä»¶ F5 ç­‰\n\nğŸ†š Ribbon çš„è´Ÿè½½å‡è¡¡ VS Nginx çš„è´Ÿè½½å‡è¡¡ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\n\nNginx çš„è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚åï¼Œè¢«æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å™¨æ‹¦æˆªï¼Œéšåè´Ÿè½½å‡è¡¡å™¨æ ¹æ®ç›¸åº”çš„è´Ÿè½½å‡è¡¡ç®—æ³•åˆ†å‘è¯·æ±‚åˆ°å…·ä½“æœåŠ¡å™¨ä¸Šå¤„ç†è¯·æ±‚ã€‚\nRibbon çš„è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œå®¢æˆ·ç«¯æƒ³æŸä¸€å¤„å‘é€è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®è‡ªèº«å†…éƒ¨ä»£ç é€»è¾‘ï¼Œå·²ç»åšå¥½äº†è´Ÿè½½å‡è¡¡çš„å®ç°ï¼Œç›´æ¥è®¿é—®åˆ°å…·ä½“çš„æœåŠ¡ã€‚Ribbon çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡é…ç½®å°±å¤„äºå¾®æœåŠ¡çš„æ¶ˆè´¹è€…ä¸­ï¼Œæ¶ˆè´¹è€…æ ¹æ®ä»£ç ä¸­è‡ªèº«æ‹¥æœ‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•ä½¿ç”¨ restTemplateè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚\n\n\nä»æ•´ä½“çš„è¯·æ±‚è¿‡ç¨‹å¯ä»¥æ˜æ˜¾çœ‹å‡ºæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å’Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å·®åˆ«ï¼š\n12æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼š å®¢æˆ·ç«¯è¯·æ±‚ ===&gt; è´Ÿè½½å‡è¡¡å™¨ ===&gt; æœåŠ¡å™¨å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼š å®¢æˆ·ç«¯è¯·æ±‚ ===&gt; æœåŠ¡å™¨\næœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å°±æ˜¯é€šè¿‡ä¸€å°æœåŠ¡å™¨è¾¾åˆ°è´Ÿè½½å‡è¡¡æ•ˆæœï¼Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æ—¶é€šè¿‡è‡ªèº«å°±èƒ½å¤Ÿè¾¾åˆ°è´Ÿè½½å‡è¡¡ï¼Œå¹¶ä¸éœ€è¦å…¶ä»–æœåŠ¡å™¨ï¼›æ›´å‡†ç¡®çš„è¯´ï¼Œå¯¹äºæœåŠ¡ç«¯çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œæ‰€æœ‰æœåŠ¡å™¨çš„æ¸…å•éƒ½æ˜¯ä¿å­˜åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸Šï¼Œè´Ÿè½½å‡è¡¡å™¨ç”¨äºç»´æŠ¤æœåŠ¡å™¨çš„å¢åŠ æˆ–å‡å°‘ã€è€Œå¯¹äºå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œå®¢æˆ·ç«¯æ‹¥æœ‰æ‰€æœ‰æœåŠ¡å™¨çš„æ¸…å•ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯èƒ½å¤Ÿè¶Šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼Œè‡ªèº«å®Œæˆè´Ÿè½½å‡è¡¡æŠ€æœ¯\n\næ ¹æ®æœ€ç»ˆè´Ÿè½½å‡è¡¡æ‰€åœ¨çš„ä½ç½®ï¼Œä¹Ÿå¯ä»¥å°†è´Ÿè½½å‡è¡¡æŠ€æœ¯åˆ†ä¸ºä¸¤ç§ï¼šé›†ä¸­å¼è´Ÿè½½å‡è¡¡ä»¥åŠè¿›ç¨‹å†…è´Ÿè½½å‡è¡¡\nÂ¶é›†ä¸­å¼ LB\né›†ä¸­å¼ LB å³åœ¨æœåŠ¡çš„æ¶ˆè´¹æ–¹å’Œæä¾›æ–¹ä¹‹é—´ä½¿ç”¨ç‹¬ç«‹çš„ LB è®¾æ–½(å¯ä»¥æ˜¯ç¡¬ä»¶ï¼Œå¦‚ F5, ä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶ï¼Œå¦‚ nginx)ï¼Œç”±è¯¥è®¾æ–½è´Ÿè´£æŠŠè®¿é—®è¯·æ±‚é€šè¿‡æŸç§ç­–ç•¥è½¬å‘è‡³æœåŠ¡çš„æä¾›æ–¹\nÂ¶è¿›ç¨‹å†… LB\nè¿›ç¨‹å†… LBï¼Œå°† LB é€»è¾‘é›†æˆåˆ°æ¶ˆè´¹æ–¹ï¼Œæ¶ˆè´¹æ–¹ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè·çŸ¥æœ‰å“ªäº›åœ°å€å¯ç”¨ï¼Œç„¶åè‡ªå·±å†ä»è¿™äº›åœ°å€ä¸­é€‰æ‹©å‡ºä¸€ä¸ªåˆé€‚çš„æœåŠ¡å™¨ã€‚Ribbon å°±å±äº 111 è¿›ç¨‹å†… LBï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç±»åº“ï¼Œé›†æˆäºæ¶ˆè´¹æ–¹è¿›ç¨‹ï¼Œæ¶ˆè´¹æ–¹é€šè¿‡å®ƒæ¥è·å–åˆ°æœåŠ¡æä¾›æ–¹çš„åœ°å€\nç®€å•çš„ç†è§£ï¼Œ Ribbion å°±æ˜¯è´Ÿè½½å‡è¡¡å’Œ RestTemplate è°ƒç”¨\n\nÂ¶Ribbon çš„è´Ÿè½½å‡è¡¡\n\nâ›µ Ribbon åœ¨å·¥ä½œæ—¶åˆ†æˆä¸¤æ­¥ï¼š\n\n\nå…ˆé€‰æ‹© EurekaServer ,å®ƒä¼˜å…ˆé€‰æ‹©åœ¨åŒä¸€ä¸ªåŒºåŸŸå†…è´Ÿè½½è¾ƒå°‘çš„ serverã€‚\n\n\næ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç­–ç•¥ï¼Œåœ¨ä» server å–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåœ°å€ã€‚\n\n\nå…¶ä¸­ Ribbon æä¾›äº†å¤šç§ç­–ç•¥ï¼šæ¯”å¦‚è½®è¯¢ã€éšæœºå’Œæ ¹æ®å“åº”æ—¶é—´åŠ æƒã€‚\n1234&lt;dependency&gt;    &lt;groupld&gt;org.springframework.cloud&lt;/groupld&gt;    &lt;artifactld&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactid&gt;&lt;/dependency&gt;\nspring-cloud-starter-netflix-eureka-client è‡ªå¸¦äº† spring-cloud-starter-ribbon å¼•ç”¨\nÂ¶Ribbon é»˜è®¤è‡ªå¸¦çš„è´Ÿè½½è§„åˆ™\nRibbon ä¸­çš„æ¯ä¸€ç§è´Ÿè½½å‡è¡¡è§„åˆ™éƒ½å¯¹åº”ç€ä¸€ä¸ªç±»ï¼Œå„ä¸ªç®—æ³•å…·ä½“çš„å«ä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\n\n\n\nç±»\nå«ä¹‰\n\n\n\n\nRoundRobinRule\nè½®è¯¢è§„åˆ™\n\n\nRandomRule\néšæœº\n\n\nRetryRule\nå…ˆæŒ‰ç…§ RoundRobinRule çš„ç­–ç•¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–æœåŠ¡å¤±è´¥åˆ™åœ¨æŒ‡å®šæ—¶é—´å†…ä¼šè¿›è¡Œé‡è¯•\n\n\nWeightedResponseTimeRule\nå¯¹ RoundRobinRule çš„æ‰©å±•ï¼Œå“åº”é€Ÿåº¦è¶Šå¿«çš„å®ä¾‹é€‰æ‹©æƒé‡è¶Šå¤§ï¼Œè¶Šå®¹æ˜“è¢«é€‰æ‹©\n\n\nBestAvailableRule\nä¼šå…ˆè¿‡æ»¤æ‰ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡æœ€å°çš„æœåŠ¡\n\n\nAvailabilityFilteringRule\nå…ˆè¿‡æ»¤æ‰æ•…éšœå®ä¾‹ï¼Œå†é€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹\n\n\nZoneAvoidanceRule\né»˜è®¤è§„åˆ™,å¤åˆåˆ¤æ–­ server æ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œ server çš„å¯ç”¨æ€§é€‰æ‹©æœåŠ¡å™¨\n\n\n\n\nå¦‚æœæƒ³è¦è‡ªå®šä¹‰å®ç°æŸä¸ªç®—æ³•ï¼Œåªéœ€è¦å®ç°IRule æ¥å£ä¸­çš„éƒ¨åˆ†æ–¹æ³•å³å¯\nÂ¶Ribbon è´Ÿè½½è§„åˆ™æ›¿æ¢\nğŸ¶ å®˜æ–¹æ–‡æ¡£æ˜ç¡®ç»™å‡ºäº†è­¦å‘Šï¼š è‡ªå®šä¹‰çš„ Ribbon è´Ÿè½½å‡è¡¡ç±»ä¸èƒ½æ”¾åœ¨@componentScanæ‰€æ‰«æçš„å½“å‰åŒ…åŠå…¶å­åŒ…ä¸‹ï¼Œå¦åˆ™è¿™ä¸ªè‡ªå®šä¹‰çš„é…ç½®ç±»å°±ä¼šè¢«æ‰€æœ‰çš„ Ribbon å®¢æˆ·ç«¯æ‰€å…±äº«ï¼Œè¾¾ä¸åˆ°ç‰¹æ®ŠåŒ–å®šåˆ¶çš„ç›®çš„ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ä¸è¦å°† Ribbon é…ç½®ç±»ä¸ä¸»å¯åŠ¨ç±»æ”¾åœ¨åŒä¸€ä¸ªåŒ…ä¸­\n12345678//åœ¨å¦ä¸€ä¸ªå­åŒ…ä¸­å‘ Spring ä¸­æ³¨å…¥ IRule ç»„ä»¶@Configurationpublic class MySelfRule &#123;\t@Bean\tpublic IRule myRule() &#123;\t\treturn new RandomRule();\t&#125;&#125;\n123456789@SpringBootApplication@EnableEurekaClient//å‘ spring boot å£°æ˜å½“å‰å¾®æœåŠ¡éœ€è¦ä½¿ç”¨çš„ ribbon è§„åˆ™@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;, configuration = MySelfRule.class)public class OrderMain80 &#123;\tpublic static void main(String[] args) &#123;\t\tSpringApplication.run(OrderMain80.class, args);\t&#125;&#125;\nğŸ¶ ç”±äºæœ€ç»ˆä½¿ç”¨çš„æ˜¯RestTemplateè¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯¹æ³¨å…¥çš„RestTemplate è¿›è¡Œé…ç½®\n\n123456789@Configurationpublic class ApplicationContextConfig &#123;\t@Bean\t@LoadBalanced\t//å£°æ˜ resttemplate ä½¿ç”¨ ribbon è´Ÿè½½å‡è¡¡\tpublic RestTemplate getRestTemplate() &#123;\t\treturn new RestTemplate();\t&#125;&#125;\nÂ¶Ribbon é»˜è®¤è´Ÿè½½è½®è¯¢ç®—æ³•åŸç†\né»˜è®¤è´Ÿè½½è½®è®­ç®—æ³•: rest æ¥å£ç¬¬å‡ æ¬¡è¯·æ±‚æ•° % æœåŠ¡å™¨é›†ç¾¤æ€»æ•°é‡ = å®é™…è°ƒç”¨æœåŠ¡å™¨ä½ç½®ä¸‹æ ‡ï¼Œæ¯æ¬¡æœåŠ¡é‡å¯åŠ¨å rest æ¥å£è®¡æ•°ä» 1 å¼€å§‹\n\nIRule.java123456789101112131415161718public interface IRule&#123;/\\*_ choose one alive server from lb.allServers or_ lb.upServers according to key \\*_ @return choosen Server object. NULL is returned if none_ server is available\\*/    //é‡ç‚¹å…³æ³¨è¿™æ–¹æ³•    public Server choose(Object key);    public void setLoadBalancer(ILoadBalancer lb);    public ILoadBalancer getLoadBalancer();&#125;\nRoundRobinRule.java1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586ublic class RoundRobinRule extends AbstractLoadBalancerRule &#123;    private AtomicInteger nextServerCyclicCounter;    private static final boolean AVAILABLE_ONLY_SERVERS = true;    private static final boolean ALL_SERVERS = false;    private static Logger log = LoggerFactory.getLogger(RoundRobinRule.class);    public RoundRobinRule() &#123;        nextServerCyclicCounter = new AtomicInteger(0);    &#125;    public RoundRobinRule(ILoadBalancer lb) &#123;        this();        setLoadBalancer(lb);    &#125;    //é‡ç‚¹å…³æ³¨è¿™æ–¹æ³•ã€‚    public Server choose(ILoadBalancer lb, Object key) &#123;        if (lb == null) &#123;            log.warn(&quot;no load balancer&quot;);            return null;        &#125;        Server server = null;        int count = 0;        while (server == null &amp;&amp; count++ &lt; 10) &#123;            List&lt;Server&gt; reachableServers = lb.getReachableServers();            List&lt;Server&gt; allServers = lb.getAllServers();            int upCount = reachableServers.size();            int serverCount = allServers.size();            if ((upCount == 0) || (serverCount == 0)) &#123;                log.warn(&quot;No up servers available from load balancer: &quot; + lb);                return null;            &#125;            int nextServerIndex = incrementAndGetModulo(serverCount);            server = allServers.get(nextServerIndex);            if (server == null) &#123;                /* Transient. */                Thread.yield();                continue;            &#125;            if (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;                return (server);            &#125;            // Next.            server = null;        &#125;        if (count &gt;= 10) &#123;            log.warn(&quot;No available alive servers after 10 tries from load balancer: &quot;                    + lb);        &#125;        return server;    &#125;    /**     * Inspired by the implementation of &#123;@link AtomicInteger#incrementAndGet()&#125;.     *     * @param modulo The modulo to bound the value of the counter.     * @return The next value.     */    private int incrementAndGetModulo(int modulo) &#123;        for (;;) &#123;            int current = nextServerCyclicCounter.get();            int next = (current + 1) % modulo;//æ±‚ä½™æ³•            if (nextServerCyclicCounter.compareAndSet(current, next))                return next;        &#125;    &#125;    @Override    public Server choose(Object key) &#123;        return choose(getLoadBalancer(), key);    &#125;    @Override    public void initWithNiwsConfig(IClientConfig clientConfig) &#123;    &#125;&#125;\nÂ¶é™„å½•\næœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å’Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆRibbonï¼‰çš„åŒºåˆ«\nå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ä¸æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡\n","dateCreated":"2022-01-27T16:05:54+00:00","dateModified":"2023-06-07T02:13:34+00:00","datePublished":"2022-01-27T16:05:54+00:00","description":"ä»€ä¹ˆæ˜¯ Ribbon? ä¸ºä»€ä¹ˆè¦ç”¨ Ribbon?","headline":"ribbon","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://pineapple-man.github.io/ribbon/"},"publisher":{"@type":"Organization","name":"pineapple-man","sameAs":["https://github.com/pineapple-man","mailto://mingchaohu720@gmail.com"],"image":"logo.png","logo":{"@type":"ImageObject","url":"logo.png"}},"url":"https://pineapple-man.github.io/ribbon/","keywords":"SpringCloud"}</script><meta name="description" content="ä»€ä¹ˆæ˜¯ Ribbon? ä¸ºä»€ä¹ˆè¦ç”¨ Ribbon?"><meta property="og:type" content="blog"><meta property="og:title" content="ribbon"><meta property="og:url" content="https://pineapple-man.github.io/ribbon/"><meta property="og:site_name" content="pineapple-man"><meta property="og:description" content="ä»€ä¹ˆæ˜¯ Ribbon? ä¸ºä»€ä¹ˆè¦ç”¨ Ribbon?"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/springcloud/spirngcloud-ribbon-requestflow.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/springcloud/springcloud-ribbon-iruler.png"><meta property="article:published_time" content="2022-01-27T16:05:54.000Z"><meta property="article:modified_time" content="2023-06-07T02:13:34.011Z"><meta property="article:author" content="pineapple-man"><meta property="article:tag" content="SpringCloud"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/springcloud/spirngcloud-ribbon-requestflow.png"><meta property="og:image" content="https://pineapple-man.github.io/assets/images/logo.png"><link rel="stylesheet" href="/assets/css/style-oth3meuzcjopbgwqbdvoxqknhcm0sy9wkullcc94zhkkop3pmfrpl5t4fzzz.min.css"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-210516333-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-210516333-1")</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"></head><body><div id="blog"><header id="header" data-behavior="5"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/" aria-label="">pineapple-man</a></div><a class="header-right-picture" href="#about" aria-label="æ‰“å¼€é“¾æ¥: /#about"><img class="header-picture" src="/assets/images/logo.png" alt="ä½œè€…çš„å›¾ç‰‡"></a></header><nav id="sidebar" data-behavior="5"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about" aria-label="é˜…è¯»æœ‰å…³ä½œè€…çš„æ›´å¤šä¿¡æ¯"><img class="sidebar-profile-picture" src="/assets/images/logo.png" alt="ä½œè€…çš„å›¾ç‰‡"></a><h4 class="sidebar-profile-name">pineapple-man</h4><h5 class="sidebar-profile-bio"><p>åšä¸€ä¸ªè èï¼šç«™å¾—ç¬”ç›´ï¼Œå¤´æˆ´ç‹å† ï¼Œå†…å¿ƒç”œç¾</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/" rel="noopener" title="é¦–é¡µ"><i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i> <span class="sidebar-button-desc">é¦–é¡µ</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories" rel="noopener" title="åˆ†ç±»"><i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i> <span class="sidebar-button-desc">åˆ†ç±»</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags" rel="noopener" title="æ ‡ç­¾"><i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i> <span class="sidebar-button-desc">æ ‡ç­¾</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives" rel="noopener" title="å½’æ¡£"><i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i> <span class="sidebar-button-desc">å½’æ¡£</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="#about" rel="noopener" title="å…³äº"><i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i> <span class="sidebar-button-desc">å…³äº</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/pineapple-man" target="_blank" rel="noopener" title="GitHub"><i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto://mingchaohu720@gmail.com" target="_blank" rel="noopener" title="é‚®ç®±"><i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i> <span class="sidebar-button-desc">é‚®ç®±</span></a></li></ul></div></nav><div id="main" data-behavior="5" class="hasCoverMetaIn"><article class="post"><div class="post-header main-content-wrap text-center"><h1 class="post-title">ribbon</h1><div class="post-meta"><time datetime="2022-01-27T16:05:54+00:00">1æœˆ 27, 2022 </time><span>å‘å¸ƒåœ¨ </span><a class="category-link" href="/categories/Java/">Java</a> <i class="fas fa-book-open"></i> æœ¬æ–‡å…±<span class="post-count"> 1.9k </span>å­— <i class="far fa-clock"></i> é˜…è¯»é¢„è®¡<span class="post-count"> 19 </span>åˆ†é’Ÿ</div></div><div class="post-content markdown"><div class="main-content-wrap"><h1 id="table-of-contents">ç›®å½•</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">æ¦‚è¿°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F-LB"><span class="toc-text">é›†ä¸­å¼ LB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%86%85-LB"><span class="toc-text">è¿›ç¨‹å†… LB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon-%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">Ribbon çš„è´Ÿè½½å‡è¡¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon-%E9%BB%98%E8%AE%A4%E8%87%AA%E5%B8%A6%E7%9A%84%E8%B4%9F%E8%BD%BD%E8%A7%84%E5%88%99"><span class="toc-text">Ribbon é»˜è®¤è‡ªå¸¦çš„è´Ÿè½½è§„åˆ™</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon-%E8%B4%9F%E8%BD%BD%E8%A7%84%E5%88%99%E6%9B%BF%E6%8D%A2"><span class="toc-text">Ribbon è´Ÿè½½è§„åˆ™æ›¿æ¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon-%E9%BB%98%E8%AE%A4%E8%B4%9F%E8%BD%BD%E8%BD%AE%E8%AF%A2%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86"><span class="toc-text">Ribbon é»˜è®¤è´Ÿè½½è½®è¯¢ç®—æ³•åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-text">é™„å½•</span></a></li></ol><h2 id="æ¦‚è¿°"><a class="header-anchor" href="#æ¦‚è¿°">Â¶</a>æ¦‚è¿°</h2><p>Spring Cloud Ribbon æ˜¯åŸºäº Netflix Ribbon å®ç°çš„ä¸€å¥—å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å·¥å…·ï¼Œä¸»è¦åŠŸèƒ½æ˜¯<strong>æä¾›å®¢æˆ·ç«¯çš„è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•å’ŒæœåŠ¡è°ƒç”¨</strong>ã€‚Ribbon å®¢æˆ·ç«¯ç»„ä»¶æä¾›ä¸€ç³»åˆ—å®Œå–„çš„é…ç½®é¡¹å¦‚è¿æ¥è¶…æ—¶ï¼Œé‡è¯•ç­‰ã€‚ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­åˆ—å‡º Load Balancer(ç®€ç§° LB) åé¢æ‰€æœ‰çš„æœºå™¨ï¼ŒRibbon ä¼šè‡ªåŠ¨çš„å¸®åŠ©ä½ åŸºäºæŸç§è§„åˆ™(å¦‚ç®€å•è½®è¯¢ï¼Œéšæœºè¿æ¥ç­‰ï¼‰å»è¿æ¥è¿™äº›æœºå™¨ã€‚æˆ‘ä»¬å¾ˆå®¹æ˜“ä½¿ç”¨ Ribbon å®ç°è‡ªå®šä¹‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•</p><div class="alert info no-icon"><p>ğŸ““ Ribbon ç›®å‰ä¹Ÿè¿›å…¥ç»´æŠ¤æ¨¡å¼ã€‚Ribbon æœªæ¥å¯èƒ½è¢« Spring Cloud LoadBalacer æ›¿ä»£</p></div><p>â“ä»€ä¹ˆæ˜¯ Load Banlance(è´Ÿè½½å‡è¡¡)?</p><div class="alert success no-icon"><p>ç®€å•çš„è¯´å°±æ˜¯å°†ç”¨æˆ·çš„è¯·æ±‚å¹³æ‘Šçš„åˆ†é…åˆ°å¤šä¸ªæœåŠ¡ä¸Šï¼Œä»è€Œè¾¾åˆ°ç³»ç»Ÿçš„ HA (é«˜å¯ç”¨)ï¼Œå¸¸è§çš„è´Ÿè½½å‡è¡¡æœ‰è½¯ä»¶ Nginxï¼ŒLVSï¼Œç¡¬ä»¶ F5 ç­‰</p></div><p>ğŸ†š Ribbon çš„è´Ÿè½½å‡è¡¡ VS Nginx çš„è´Ÿè½½å‡è¡¡ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><div class="alert success no-icon"><ul><li>Nginx çš„è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚åï¼Œè¢«æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å™¨æ‹¦æˆªï¼Œéšåè´Ÿè½½å‡è¡¡å™¨æ ¹æ®ç›¸åº”çš„è´Ÿè½½å‡è¡¡ç®—æ³•åˆ†å‘è¯·æ±‚åˆ°å…·ä½“æœåŠ¡å™¨ä¸Šå¤„ç†è¯·æ±‚ã€‚</li><li>Ribbon çš„è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œå®¢æˆ·ç«¯æƒ³æŸä¸€å¤„å‘é€è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®è‡ªèº«å†…éƒ¨ä»£ç é€»è¾‘ï¼Œå·²ç»åšå¥½äº†è´Ÿè½½å‡è¡¡çš„å®ç°ï¼Œç›´æ¥è®¿é—®åˆ°å…·ä½“çš„æœåŠ¡ã€‚Ribbon çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡é…ç½®å°±å¤„äºå¾®æœåŠ¡çš„æ¶ˆè´¹è€…ä¸­ï¼Œæ¶ˆè´¹è€…æ ¹æ®ä»£ç ä¸­è‡ªèº«æ‹¥æœ‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•ä½¿ç”¨ <code>restTemplate</code>è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚</li></ul></div><p>ä»æ•´ä½“çš„è¯·æ±‚è¿‡ç¨‹å¯ä»¥æ˜æ˜¾çœ‹å‡ºæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å’Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å·®åˆ«ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼š å®¢æˆ·ç«¯è¯·æ±‚ ===&gt; è´Ÿè½½å‡è¡¡å™¨ ===&gt; æœåŠ¡å™¨</span><br><span class="line">å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼š å®¢æˆ·ç«¯è¯·æ±‚ ===&gt; æœåŠ¡å™¨</span><br></pre></td></tr></table></figure><div class="alert info no-icon"><p>æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å°±æ˜¯é€šè¿‡ä¸€å°æœåŠ¡å™¨è¾¾åˆ°è´Ÿè½½å‡è¡¡æ•ˆæœï¼Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æ—¶é€šè¿‡è‡ªèº«å°±èƒ½å¤Ÿè¾¾åˆ°è´Ÿè½½å‡è¡¡ï¼Œå¹¶ä¸éœ€è¦å…¶ä»–æœåŠ¡å™¨ï¼›æ›´å‡†ç¡®çš„è¯´ï¼Œå¯¹äºæœåŠ¡ç«¯çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œæ‰€æœ‰æœåŠ¡å™¨çš„æ¸…å•éƒ½æ˜¯ä¿å­˜åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸Šï¼Œè´Ÿè½½å‡è¡¡å™¨ç”¨äºç»´æŠ¤æœåŠ¡å™¨çš„å¢åŠ æˆ–å‡å°‘ã€è€Œå¯¹äºå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œå®¢æˆ·ç«¯æ‹¥æœ‰æ‰€æœ‰æœåŠ¡å™¨çš„æ¸…å•ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯èƒ½å¤Ÿè¶Šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼Œè‡ªèº«å®Œæˆè´Ÿè½½å‡è¡¡æŠ€æœ¯</p></div><p>æ ¹æ®æœ€ç»ˆè´Ÿè½½å‡è¡¡æ‰€åœ¨çš„ä½ç½®ï¼Œä¹Ÿå¯ä»¥å°†è´Ÿè½½å‡è¡¡æŠ€æœ¯åˆ†ä¸ºä¸¤ç§ï¼šé›†ä¸­å¼è´Ÿè½½å‡è¡¡ä»¥åŠè¿›ç¨‹å†…è´Ÿè½½å‡è¡¡</p><h3 id="é›†ä¸­å¼-LB"><a class="header-anchor" href="#é›†ä¸­å¼-LB">Â¶</a>é›†ä¸­å¼ LB</h3><p>é›†ä¸­å¼ LB å³åœ¨æœåŠ¡çš„æ¶ˆè´¹æ–¹å’Œæä¾›æ–¹ä¹‹é—´ä½¿ç”¨ç‹¬ç«‹çš„ LB è®¾æ–½(å¯ä»¥æ˜¯ç¡¬ä»¶ï¼Œå¦‚ F5, ä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶ï¼Œå¦‚ nginx)ï¼Œç”±è¯¥è®¾æ–½è´Ÿè´£æŠŠè®¿é—®è¯·æ±‚é€šè¿‡æŸç§ç­–ç•¥è½¬å‘è‡³æœåŠ¡çš„æä¾›æ–¹</p><h3 id="è¿›ç¨‹å†…-LB"><a class="header-anchor" href="#è¿›ç¨‹å†…-LB">Â¶</a>è¿›ç¨‹å†… LB</h3><p>è¿›ç¨‹å†… LBï¼Œå°† LB é€»è¾‘é›†æˆåˆ°æ¶ˆè´¹æ–¹ï¼Œæ¶ˆè´¹æ–¹ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè·çŸ¥æœ‰å“ªäº›åœ°å€å¯ç”¨ï¼Œç„¶åè‡ªå·±å†ä»è¿™äº›åœ°å€ä¸­é€‰æ‹©å‡ºä¸€ä¸ªåˆé€‚çš„æœåŠ¡å™¨ã€‚Ribbon å°±å±äº 111 è¿›ç¨‹å†… LBï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç±»åº“ï¼Œé›†æˆäºæ¶ˆè´¹æ–¹è¿›ç¨‹ï¼Œæ¶ˆè´¹æ–¹é€šè¿‡å®ƒæ¥è·å–åˆ°æœåŠ¡æä¾›æ–¹çš„åœ°å€</p><div class="alert info no-icon"><p>ç®€å•çš„ç†è§£ï¼Œ Ribbion å°±æ˜¯è´Ÿè½½å‡è¡¡å’Œ RestTemplate è°ƒç”¨</p></div><h2 id="Ribbon-çš„è´Ÿè½½å‡è¡¡"><a class="header-anchor" href="#Ribbon-çš„è´Ÿè½½å‡è¡¡">Â¶</a>Ribbon çš„è´Ÿè½½å‡è¡¡</h2><p><img src="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/springcloud/spirngcloud-ribbon-requestflow.png" alt=""></p><p>â›µ Ribbon åœ¨å·¥ä½œæ—¶åˆ†æˆä¸¤æ­¥ï¼š</p><ol><li><p>å…ˆé€‰æ‹© EurekaServer ,å®ƒä¼˜å…ˆé€‰æ‹©åœ¨åŒä¸€ä¸ªåŒºåŸŸå†…è´Ÿè½½è¾ƒå°‘çš„ serverã€‚</p></li><li><p>æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç­–ç•¥ï¼Œåœ¨ä» server å–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåœ°å€ã€‚</p></li></ol><p>å…¶ä¸­ Ribbon æä¾›äº†å¤šç§ç­–ç•¥ï¼šæ¯”å¦‚è½®è¯¢ã€éšæœºå’Œæ ¹æ®å“åº”æ—¶é—´åŠ æƒã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupld</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupld</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactld</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>spring-cloud-starter-netflix-eureka-client è‡ªå¸¦äº† spring-cloud-starter-ribbon å¼•ç”¨</p><h2 id="Ribbon-é»˜è®¤è‡ªå¸¦çš„è´Ÿè½½è§„åˆ™"><a class="header-anchor" href="#Ribbon-é»˜è®¤è‡ªå¸¦çš„è´Ÿè½½è§„åˆ™">Â¶</a>Ribbon é»˜è®¤è‡ªå¸¦çš„è´Ÿè½½è§„åˆ™</h2><p>Ribbon ä¸­çš„æ¯ä¸€ç§è´Ÿè½½å‡è¡¡è§„åˆ™éƒ½å¯¹åº”ç€ä¸€ä¸ªç±»ï¼Œå„ä¸ªç®—æ³•å…·ä½“çš„å«ä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th style="text-align:center">ç±»</th><th style="text-align:center">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center">RoundRobinRule</td><td style="text-align:center">è½®è¯¢è§„åˆ™</td></tr><tr><td style="text-align:center">RandomRule</td><td style="text-align:center">éšæœº</td></tr><tr><td style="text-align:center">RetryRule</td><td style="text-align:center">å…ˆæŒ‰ç…§ RoundRobinRule çš„ç­–ç•¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–æœåŠ¡å¤±è´¥åˆ™åœ¨æŒ‡å®šæ—¶é—´å†…ä¼šè¿›è¡Œé‡è¯•</td></tr><tr><td style="text-align:center">WeightedResponseTimeRule</td><td style="text-align:center">å¯¹ RoundRobinRule çš„æ‰©å±•ï¼Œå“åº”é€Ÿåº¦è¶Šå¿«çš„å®ä¾‹é€‰æ‹©æƒé‡è¶Šå¤§ï¼Œè¶Šå®¹æ˜“è¢«é€‰æ‹©</td></tr><tr><td style="text-align:center">BestAvailableRule</td><td style="text-align:center">ä¼šå…ˆè¿‡æ»¤æ‰ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡æœ€å°çš„æœåŠ¡</td></tr><tr><td style="text-align:center">AvailabilityFilteringRule</td><td style="text-align:center">å…ˆè¿‡æ»¤æ‰æ•…éšœå®ä¾‹ï¼Œå†é€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹</td></tr><tr><td style="text-align:center">ZoneAvoidanceRule</td><td style="text-align:center">é»˜è®¤è§„åˆ™,å¤åˆåˆ¤æ–­ server æ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œ server çš„å¯ç”¨æ€§é€‰æ‹©æœåŠ¡å™¨</td></tr></tbody></table><p><img src="https://cdn.jsdelivr.net/gh/pineapple-man/blogImage@main/image/springcloud/springcloud-ribbon-iruler.png" alt=""></p><p>å¦‚æœæƒ³è¦è‡ªå®šä¹‰å®ç°æŸä¸ªç®—æ³•ï¼Œåªéœ€è¦å®ç°<code>IRule</code> æ¥å£ä¸­çš„éƒ¨åˆ†æ–¹æ³•å³å¯</p><h2 id="Ribbon-è´Ÿè½½è§„åˆ™æ›¿æ¢"><a class="header-anchor" href="#Ribbon-è´Ÿè½½è§„åˆ™æ›¿æ¢">Â¶</a>Ribbon è´Ÿè½½è§„åˆ™æ›¿æ¢</h2><p>ğŸ¶ å®˜æ–¹æ–‡æ¡£æ˜ç¡®ç»™å‡ºäº†è­¦å‘Šï¼š è‡ªå®šä¹‰çš„ Ribbon è´Ÿè½½å‡è¡¡ç±»ä¸èƒ½æ”¾åœ¨<code>@componentScan</code>æ‰€æ‰«æçš„å½“å‰åŒ…åŠå…¶å­åŒ…ä¸‹ï¼Œå¦åˆ™è¿™ä¸ªè‡ªå®šä¹‰çš„é…ç½®ç±»å°±ä¼šè¢«æ‰€æœ‰çš„ Ribbon å®¢æˆ·ç«¯æ‰€å…±äº«ï¼Œè¾¾ä¸åˆ°ç‰¹æ®ŠåŒ–å®šåˆ¶çš„ç›®çš„ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ä¸è¦å°† Ribbon é…ç½®ç±»ä¸ä¸»å¯åŠ¨ç±»æ”¾åœ¨åŒä¸€ä¸ªåŒ…ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨å¦ä¸€ä¸ªå­åŒ…ä¸­å‘ Spring ä¸­æ³¨å…¥ IRule ç»„ä»¶</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelfRule</span> &#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> IRule <span class="title function_">myRule</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="comment">//å‘ spring boot å£°æ˜å½“å‰å¾®æœåŠ¡éœ€è¦ä½¿ç”¨çš„ ribbon è§„åˆ™</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;, configuration = MySelfRule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMain80</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(OrderMain80.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="alert success no-icon"><p>ğŸ¶ ç”±äºæœ€ç»ˆä½¿ç”¨çš„æ˜¯<code>RestTemplate</code>è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯¹æ³¨å…¥çš„<code>RestTemplate</code>è¿›è¡Œé…ç½®</p></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@LoadBalanced</span></span><br><span class="line">	<span class="comment">//å£°æ˜ resttemplate ä½¿ç”¨ ribbon è´Ÿè½½å‡è¡¡</span></span><br><span class="line">	<span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Ribbon-é»˜è®¤è´Ÿè½½è½®è¯¢ç®—æ³•åŸç†"><a class="header-anchor" href="#Ribbon-é»˜è®¤è´Ÿè½½è½®è¯¢ç®—æ³•åŸç†">Â¶</a>Ribbon é»˜è®¤è´Ÿè½½è½®è¯¢ç®—æ³•åŸç†</h2><div class="alert success no-icon"><p>é»˜è®¤è´Ÿè½½è½®è®­ç®—æ³•: rest æ¥å£ç¬¬å‡ æ¬¡è¯·æ±‚æ•° % æœåŠ¡å™¨é›†ç¾¤æ€»æ•°é‡ = å®é™…è°ƒç”¨æœåŠ¡å™¨ä½ç½®ä¸‹æ ‡ï¼Œæ¯æ¬¡æœåŠ¡é‡å¯åŠ¨å rest æ¥å£è®¡æ•°ä» 1 å¼€å§‹</p></div><figure class="highlight java"><figcaption><span>IRule.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRule</span>&#123;</span><br><span class="line">/\*</span><br><span class="line">_ choose one alive server from lb.allServers or</span><br><span class="line">_ lb.upServers according to key \*</span><br><span class="line">_ <span class="meta">@return</span> choosen Server object. NULL is returned <span class="keyword">if</span> none</span><br><span class="line">_ server is available</span><br><span class="line">\*/</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡ç‚¹å…³æ³¨è¿™æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoadBalancer</span><span class="params">(ILoadBalancer lb)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ILoadBalancer <span class="title function_">getLoadBalancer</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>RoundRobinRule.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">ublic <span class="keyword">class</span> <span class="title class_">RoundRobinRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractLoadBalancerRule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger nextServerCyclicCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">AVAILABLE_ONLY_SERVERS</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">ALL_SERVERS</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RoundRobinRule.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RoundRobinRule</span><span class="params">()</span> &#123;</span><br><span class="line">        nextServerCyclicCounter = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RoundRobinRule</span><span class="params">(ILoadBalancer lb)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>();</span><br><span class="line">        setLoadBalancer(lb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡ç‚¹å…³æ³¨è¿™æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lb == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;no load balancer&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (server == <span class="literal">null</span> &amp;&amp; count++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            List&lt;Server&gt; reachableServers = lb.getReachableServers();</span><br><span class="line">            List&lt;Server&gt; allServers = lb.getAllServers();</span><br><span class="line">            <span class="type">int</span> <span class="variable">upCount</span> <span class="operator">=</span> reachableServers.size();</span><br><span class="line">            <span class="type">int</span> <span class="variable">serverCount</span> <span class="operator">=</span> allServers.size();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((upCount == <span class="number">0</span>) || (serverCount == <span class="number">0</span>)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;No up servers available from load balancer: &quot;</span> + lb);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextServerIndex</span> <span class="operator">=</span> incrementAndGetModulo(serverCount);</span><br><span class="line">            server = allServers.get(nextServerIndex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">/* Transient. */</span></span><br><span class="line">                Thread.<span class="keyword">yield</span>();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;</span><br><span class="line">                <span class="keyword">return</span> (server);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Next.</span></span><br><span class="line">            server = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span></span><br><span class="line">                    + lb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> server;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Inspired by the implementation of &#123;<span class="doctag">@link</span> AtomicInteger#incrementAndGet()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modulo The modulo to bound the value of the counter.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The next value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">incrementAndGetModulo</span><span class="params">(<span class="type">int</span> modulo)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> nextServerCyclicCounter.get();</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> (current + <span class="number">1</span>) % modulo;<span class="comment">//æ±‚ä½™æ³•</span></span><br><span class="line">            <span class="keyword">if</span> (nextServerCyclicCounter.compareAndSet(current, next))</span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> choose(getLoadBalancer(), key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initWithNiwsConfig</span><span class="params">(IClientConfig clientConfig)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é™„å½•"><a class="header-anchor" href="#é™„å½•">Â¶</a>é™„å½•</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/22b2c362b973">æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å’Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆRibbonï¼‰çš„åŒºåˆ«</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014401141/article/details/78676296">å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ä¸æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡</a></p></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">æ ‡ç­¾</span><br><a class="tag tag--primary tag--small t-none-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/mysql%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" data-tooltip="mysqlè¸©å‘è®°å½•" aria-label="ä¸Šä¸€ç¯‡: mysqlè¸©å‘è®°å½•"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">ä¸Šä¸€ç¯‡</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F-%E2%98%9E-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" data-tooltip="ç»“æ„å‹æ¨¡å¼ â˜ ä»£ç†æ¨¡å¼" aria-label="ä¸‹ä¸€ç¯‡: ç»“æ„å‹æ¨¡å¼ â˜ ä»£ç†æ¨¡å¼"><span class="hide-xs hide-sm text-small icon-mr">ä¸‹ä¸€ç¯‡</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="ç›®å½•"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div></article><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });</script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2023 pineapple-man. All Rights Reserved.</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><br>Total <span id="busuanzi_value_site_pv"></span> views. æ‚¨æ˜¯pineapple-mançš„ç¬¬<span id="busuanzi_value_site_uv"></span>ä¸ªå°ä¼™ä¼´<br><i class="fas fa-book-open"></i> <span class="post-count">åšå®¢å­—æ•°ç»Ÿè®¡ï¼š370.7k</span><script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script></footer></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="5"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/mysql%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" data-tooltip="mysqlè¸©å‘è®°å½•" aria-label="ä¸Šä¸€ç¯‡: mysqlè¸©å‘è®°å½•"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">ä¸Šä¸€ç¯‡</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F-%E2%98%9E-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" data-tooltip="ç»“æ„å‹æ¨¡å¼ â˜ ä»£ç†æ¨¡å¼" aria-label="ä¸‹ä¸€ç¯‡: ç»“æ„å‹æ¨¡å¼ â˜ ä»£ç†æ¨¡å¼"><span class="hide-xs hide-sm text-small icon-mr">ä¸‹ä¸€ç¯‡</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="ç›®å½•"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-times"></i></div><img id="about-card-picture" src="/assets/images/logo.png" alt="ä½œè€…çš„å›¾ç‰‡"><h4 id="about-card-name">pineapple-man</h4><div id="about-card-bio"><p>åšä¸€ä¸ªè èï¼šç«™å¾—ç¬”ç›´ï¼Œå¤´æˆ´ç‹å† ï¼Œå†…å¿ƒç”œç¾</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>åˆšæ¯•ä¸šå°±å¤±ä¸š</p></div><div id="about-card-location"><i class="fa fa-map-marker-alt"></i><br>è¥¿å®‰</div></div></div><div id="cover" style="background-image:url(/assets/images/cover-v1.2.0.jpg)"></div><script src="/assets/js/script-kcoiyt1nxfue7qgcpkrcixymglcc3cuxeg98fy01hqww4nblnhd2ees6j6yc.min.js"></script></body></html>